<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chequeo Digital ‚Äì ¬øQu√© tan digital es tu empresa?</title>

<!-- Bootstrap 5 & Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<style>
:root{
  --primary:#0d6efd;
  --accent:#0bbbc5;
  --ink:#1d1d4f;
}
body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif; }

/* ===== HERO ===== */
.hero{
  background: radial-gradient(1200px 600px at 10% 10%, #e9f5ff 0%, transparent 40%),
              radial-gradient(900px 500px at 100% 0%, #e6fffb 0%, transparent 40%),
              linear-gradient(180deg,#ffffff 0%, #f7f9fc 100%);
}
.hero-title{ color: var(--ink); font-weight: 800; letter-spacing: .2px; }
.badge-kicker{ background: #e7f1ff; color: #0a58ca; font-weight:600; }
.cta{
  background: var(--accent); border: none; color:#fff; font-weight:700;
  padding:.9rem 1.4rem; border-radius: 999px; transition: transform .15s ease, box-shadow .15s ease;
}
.cta:hover{ transform: translateY(-1px); box-shadow:0 10px 20px rgba(11,187,197,.2); }
.hero-illus{ max-width: 520px; }

/* ===== FEATURES ===== */
.feature-card{ border:0; box-shadow:0 10px 25px rgba(13,110,253,.08); border-radius: 16px; }
.feature-icon{ width:56px; height:56px; display:grid; place-items:center; border-radius:12px; background:#eef5ff; color:#0d6efd; }

/* ===== DIMENSIONS ===== */
.dim-item{ border-radius:14px; padding:1.2rem; background:#ffffff; box-shadow:0 8px 20px rgba(0,0,0,.06); }
.dim-icon{ font-size:1.8rem; color:#0d6efd; }

/* ===== NUEVAS SECCIONES ===== */
#welcomeSection, #prevResultsSection, #autoDx { display:none; }
.section-hero {
  background: linear-gradient(135deg, #0f1a3b, #0b8);
  color:#fff; border-radius:20px; padding:24px; box-shadow:0 18px 40px rgba(0,0,0,.2);
}
.card-soft { background:#fff; border:1px solid #e9eef8; border-radius:16px; box-shadow:0 10px 26px rgba(0,0,0,.06); }

/* NAV logged-in */
.nav-company { font-weight:700; color:#0d6efd; }
.nav-help { color:#0bbbc5; font-size:1.25rem; margin-left:12px; }
.nav-logout { margin-left:8px; }

/* ===== PRINT: ocultar todo salvo el informe ===== */
@media print{
  body *{ visibility:hidden !important; }
  #dxReport, #dxReport *{ visibility:visible !important; }
  #dxReport{ position:absolute; left:0; top:0; width:100%; box-shadow:none; }
}

/* ===== Modales simples (overlay propio) ===== */
.modal-overlay{
  display:none; position:fixed; inset:0; z-index:1050;
  background: rgba(0,0,0,.45);
  align-items: center; justify-content: center;
}
.modal-card{
  width: min(560px, 92vw);
  background: #fff; color:#1a1f36;
  border-radius: 16px; padding: 20px;
  box-shadow: 0 24px 60px rgba(0,0,0,.35);
  position: relative;
}
.modal-card .closeModal{
  position:absolute; top:8px; right:12px; border:0; background:transparent;
  font-size: 28px; line-height: 1; cursor:pointer; color:#6b7280;
}
</style>
</head>
<body>

<!-- ===== NAVBAR ===== -->
<nav class="navbar navbar-expand-md py-3 border-bottom bg-white">
  <div class="container">
    <a class="navbar-brand fw-bold text-primary" href="#" id="brandName">Chequeo Digital</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div id="nav" class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto align-items-md-center gap-2" id="navAnon">
        <li class="nav-item"><a class="nav-link" href="#beneficios">Beneficios</a></li>
        <li class="nav-item"><a class="nav-link" href="#como-funciona">C√≥mo funciona</a></li>
        <li class="nav-item ms-md-2"><a class="btn btn-outline-primary rounded-pill openLogin" href="#">Iniciar sesi√≥n</a></li>
      </ul>

      <!-- Nav cuando hay sesi√≥n -->
      <div class="ms-auto d-none align-items-center gap-3" id="navAuth">
        <span class="nav-company" id="navCompany">Empresa</span>
        <a class="nav-help" title="Soporte" id="navHelp" href="#" role="button" aria-label="Soporte">
          <i class="bi bi-question-circle"></i>
        </a>
        <button class="btn btn-outline-danger btn-sm rounded-pill nav-logout" id="btnLogout"><i class="bi bi-box-arrow-right me-1"></i> Cerrar sesi√≥n</button>
      </div>
    </div>
  </div>
</nav>

<!-- ===== LANDING ===== -->
<div id="landing">
  <!-- HERO -->
  <section class="hero py-5 py-lg-6">
    <div class="container">
      <div class="row align-items-center g-4 g-lg-5">
        <div class="col-12 col-lg-6">
          <span class="badge badge-kicker rounded-pill px-3 py-2 mb-3">Chequeo Digital</span>
          <h1 class="hero-title display-5 mb-3">¬øQu√© tan digital es tu empresa?</h1>
          <p class="lead text-secondary mb-4">Eval√∫a en minutos tu nivel de madurez digital y recibe un plan de acci√≥n pr√°ctico para impulsar procesos, herramientas y habilidades.</p>
          <div class="d-flex gap-3">
            <a href="#" class="cta openRegistro">Comenzar diagn√≥stico</a>
            <a href="#beneficios" class="btn btn-link">Ver beneficios <i class="bi bi-arrow-down-right"></i></a>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <!-- Ilustraci√≥n -->
          <svg class="hero-illus w-100" viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <defs>
              <linearGradient id="grad-a" x1="0" x2="1" y1="0" y2="1">
                <stop offset="0%" stop-color="#0d6efd"/>
                <stop offset="100%" stop-color="#0bbbc5"/>
              </linearGradient>
              <linearGradient id="grad-b" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#ffffff" stop-opacity=".0"/>
                <stop offset="100%" stop-color="#ffffff" stop-opacity=".5"/>
              </linearGradient>
              <filter id="blur1"><feGaussianBlur stdDeviation="20"/></filter>
            </defs>
            <ellipse cx="640" cy="120" rx="140" ry="90" fill="#dff2ff"/>
            <circle cx="560" cy="480" r="90" fill="#e6fffb"/>
            <rect x="210" y="80" rx="40" ry="40" width="280" height="440" fill="#111a3a"/>
            <rect x="225" y="100" rx="28" ry="28" width="250" height="400" fill="#0f1533"/>
            <rect x="230" y="110" width="240" height="260" fill="url(#grad-a)" opacity=".85"/>
            <rect x="230" y="110" width="240" height="260" fill="url(#grad-b)"/>
            <g transform="translate(230,110)">
              <rect width="240" height="36" fill="#ffffff"/>
              <rect width="40" height="36" fill="#0d6efd"/>
              <rect x="80" width="40" height="36" fill="#0d6efd"/>
              <rect x="160" width="40" height="36" fill="#0d6efd"/>
            </g>
            <rect x="246" y="196" width="208" height="140" rx="14" fill="#ffffff"/>
            <rect x="258" y="210" width="80" height="72" rx="10" fill="#eef5ff"/>
            <rect x="258" y="290" width="80" height="14" rx="7" fill="#d7e7ff"/>
            <rect x="352" y="210" width="86" height="14" rx="7" fill="#9edee4"/>
            <rect x="352" y="232" width="110" height="10" rx="5" fill="#cfe2ff"/>
            <rect x="352" y="250" width="110" height="10" rx="5" fill="#cfe2ff"/>
            <rect x="352" y="270" width="72" height="10" rx="5" fill="#ffe6b3"/>
            <rect x="352" y="290" width="96" height="12" rx="6" fill="#0bbbc5"/>
            <ellipse cx="350" cy="540" rx="200" ry="30" fill="#0d6efd" opacity=".15" filter="url(#blur1)"/>
          </svg>
        </div>
      </div>
    </div>
  </section>

  <!-- BENEFICIOS -->
  <section id="beneficios" class="py-5 bg-light">
    <div class="container">
      <h2 class="text-center fw-bold mb-4" style="color:var(--ink)">Completa el Chequeo Digital y obt√©n</h2>
      <div class="row g-4 g-lg-5 justify-content-center">
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card feature-card h-100 p-3 p-md-4">
            <div class="d-flex align-items-center gap-3 mb-3">
              <div class="feature-icon"><i class="bi bi-file-earmark-text"></i></div>
              <h5 class="mb-0">Informe personalizado</h5>
            </div>
            <p class="mb-0 text-secondary">Un an√°lisis claro del estado actual de tu adopci√≥n tecnol√≥gica y de las competencias digitales de tu organizaci√≥n.</p>
          </div>
        </div>
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card feature-card h-100 p-3 p-md-4">
            <div class="d-flex align-items-center gap-3 mb-3">
              <div class="feature-icon"><i class="bi bi-stars"></i></div>
              <h5 class="mb-0">Recomendaciones accionables</h5>
            </div>
            <p class="mb-0 text-secondary">Acciones priorizadas para fortalecer procesos, seleccionar herramientas y desarrollar habilidades de forma pr√°ctica.</p>
          </div>
        </div>
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card feature-card h-100 p-3 p-md-4">
            <div class="d-flex align-items-center gap-3 mb-3">
              <div class="feature-icon"><i class="bi bi-clipboard-data"></i></div>
              <h5 class="mb-0">Historial de progreso</h5>
            </div>
            <p class="mb-0 text-secondary">Un registro para comparar resultados en futuros chequeos y medir la evoluci√≥n de tu madurez digital.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- DIMENSIONES -->
  <section id="como-funciona" class="py-5">
    <div class="container">
      <div class="row justify-content-center mb-4">
        <div class="col-lg-8 text-center">
          <h2 class="fw-bold" style="color:var(--ink)">¬øC√≥mo funciona el Chequeo Digital?</h2>
          <p class="text-secondary mt-2">Responder√°s en aproximadamente 25 minutos un conjunto de preguntas sobre 6 dimensiones clave de tu empresa.</p>
        </div>
      </div>
      <div class="row g-4 g-lg-4">
        <div class="col-6 col-md-4"><div class="dim-item h-100 text-center"><div class="dim-icon mb-2"><i class="bi bi-cpu"></i></div><div class="fw-semibold">Tecnolog√≠a y habilidades digitales</div></div></div>
        <div class="col-6 col-md-4"><div class="dim-item h-100 text-center"><div class="dim-icon mb-2"><i class="bi bi-chat-square-dots"></i></div><div class="fw-semibold">Comunicaciones y canales de venta</div></div></div>
        <div class="col-6 col-md-4"><div class="dim-item h-100 text-center"><div class="dim-icon mb-2"><i class="bi bi-people"></i></div><div class="fw-semibold">Organizaci√≥n y personas</div></div></div>
        <div class="col-6 col-md-4"><div class="dim-item h-100 text-center"><div class="dim-icon mb-2"><i class="bi bi-bullseye"></i></div><div class="fw-semibold">Estrategia y transformaci√≥n digital</div></div></div>
        <div class="col-6 col-md-4"><div class="dim-item h-100 text-center"><div class="dim-icon mb-2"><i class="bi bi-bar-chart-line"></i></div><div class="fw-semibold">Datos y anal√≠tica</div></div></div>
        <div class="col-6 col-md-4"><div class="dim-item h-100 text-center"><div class="dim-icon mb-2"><i class="bi bi-gear"></i></div><div class="fw-semibold">Procesos</div></div></div>
      </div>
    </div>
  </section>

  <!-- CTA DIAGN√ìSTICO -->
  <section id="diagnostico" class="py-5 bg-light">
    <div class="container text-center">
      <h3 class="fw-bold mb-2">Pr√≥ximo paso</h3>
      <p class="text-secondary mb-4">Aqu√≠ conectaremos el formulario del autodiagn√≥stico con tus 25 preguntas.</p>
      <a href="#" class="btn btn-primary rounded-pill px-4 openRegistro">Empezar ahora</a>
    </div>
  </section>

  <footer class="py-4 text-center text-white" style="background:#0d6efd;">
    <div class="container small">¬© 2025 Chequeo Digital ‚Äî Proyecto acad√©mico</div>
  </footer>
</div><!-- /landing -->

<!-- ===== SECCI√ìN BIENVENIDA (post-registro) ===== -->
<section id="welcomeSection" class="py-5">
  <div class="container">
    <div class="section-hero d-flex align-items-center justify-content-between flex-column flex-lg-row">
      <div class="me-lg-4">
        <h2 class="mb-2">¬°Bienvenido, <span id="welcCompany">Empresa</span>! üëã</h2>
        <p class="mb-3">Est√°s listo para realizar tu <strong>Autodiagn√≥stico de Madurez Digital</strong>. Obtendr√°s un informe con nivel global, desempe√±o por dimensiones, barreras clave y una hoja de ruta priorizada.</p>
        <button class="btn btn-light text-primary rounded-pill px-4" id="goToDx1"><i class="bi bi-clipboard-check me-1"></i> Ir al Autodiagn√≥stico</button>
      </div>
      <img src="https://images.unsplash.com/photo-1519389950473-47ba0277781c?auto=format&fit=crop&w=1200&q=60" alt="Bienvenida" class="rounded-4 mt-4 mt-lg-0" style="max-width:420px; box-shadow:0 20px 40px rgba(0,0,0,.25)">
    </div>
  </div>
</section>

<!-- ===== SECCI√ìN RESULTADOS PREVIOS (post-login) ===== -->
<section id="prevResultsSection" class="py-5">
  <div class="container">
    <div class="mb-4">
      <div class="section-hero">
        <div class="d-flex align-items-center justify-content-between flex-wrap">
          <div>
            <h3 class="mb-1">Resultados previos de <span id="resCompany">Empresa</span></h3>
            <p class="mb-0 opacity-75">Consulta tus autodiagn√≥sticos, vuelve a abrir el informe y desc√°rgalo en PDF.</p>
          </div>
          <button class="btn btn-light text-primary rounded-pill mt-3 mt-md-0" id="goToDx2"><i class="bi bi-plus-circle me-1"></i> Nuevo Autodiagn√≥stico</button>
        </div>
      </div>
    </div>

    <div id="resultsSummary" class="mt-3"></div>
    <div id="resultsList" class="row g-3">
      <!-- Cards con resultados previos -->
    </div>
  </div>
</section>

<!-- ================== MODALES ================== -->
<div id="registroModal" class="modal-overlay">
  <div class="modal-card">
    <button class="closeModal">&times;</button>
    <h2 class="text-primary mb-3">Registro de Empresa</h2>
    <form id="registroForm">
      <div class="mb-3">
        <label class="form-label">Nombre de la Empresa:</label>
        <input type="text" id="empresaReg" class="form-control rounded-3" placeholder="Ej: Mi Empresa S.A." required>
      </div>
      <div class="mb-3">
        <label class="form-label">Email:</label>
        <input type="email" id="email" class="form-control rounded-3" placeholder="Ej: correo@empresa.com" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Contrase√±a:</label>
        <input type="password" id="password" class="form-control rounded-3" placeholder="********" required>
      </div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="acepto" required>
        <label class="form-check-label" for="acepto">Acepto los <a href="#">t√©rminos y condiciones</a>.</label>
      </div>
      <div class="d-grid gap-2">
        <button type="submit" id="btnRegistrar" class="btn btn-primary btn-lg rounded-pill">Registrarse</button>
      </div>
    </form>
    <p id="mensaje" class="mt-3 fw-bold text-center"></p>
  </div>
</div>

<div id="loginModal" class="modal-overlay">
  <div class="modal-card">
    <button class="closeModal">&times;</button>
    <h2 class="text-primary mb-3">Iniciar sesi√≥n</h2>
    <form id="loginForm">
      <div class="mb-3">
        <label class="form-label">Email:</label>
        <input type="email" id="loginEmail" class="form-control rounded-3" placeholder="correo@empresa.com" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Contrase√±a:</label>
        <input type="password" id="loginPassword" class="form-control rounded-3" placeholder="********" required>
      </div>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="#" id="forgotPass">¬øOlvidaste tu contrase√±a?</a>
      </div>
      <div class="d-grid gap-2">
        <button type="submit" id="btnLogin" class="btn btn-primary btn-lg rounded-pill">Iniciar sesi√≥n</button>
      </div>
      <p id="loginMessage" class="mt-3 fw-bold text-center"></p>
    </form>
  </div>
</div>

<!-- ================== AUTODIAGN√ìSTICO COMPLETO ================== -->
<section id="autoDx" class="dx-wrapper">
  <style>
    :root{
      --ink:#0e1326; --muted:#7b8ca9; --primary:#5b8cff; --accent:#00c2a8;
      --bg:#0a0f1f; --card:#111831; --ok:#2ecc71; --warn:#f39c12; --bad:#e74c3c;
      --repAccent:#253359;
      --lib1:url('https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=1800&q=80');
      --lib2:url('https://images.unsplash.com/photo-1495446815901-a7297e633e8d?auto=format&fit=crop&w=1800&q=80');
    }
    .dx-wrapper{ color:#e9eefb; background:
        radial-gradient(900px 600px at 85% -10%, rgba(0,194,168,.18), transparent 40%),
        radial-gradient(800px 500px at 0% 0%, rgba(91,140,255,.18), transparent 45%),
        linear-gradient(180deg, #0a0f1f, #0a0f1f);
      padding:24px 12px; position: relative; overflow: hidden; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;}
    .dx-wrapper::before{ content:""; position:absolute; inset:-10% -10% -10% -10%;
      background-image: var(--lib1), var(--lib2); background-size: cover, 55%;
      background-position: center, 10% 30%; background-repeat: no-repeat;
      filter: grayscale(100%) contrast(90%) brightness(60%) opacity(.12) blur(1px); z-index: 0; pointer-events:none;}
    .dx-container{ max-width:980px; margin:0 auto; position:relative; z-index:1; }
    .dx-card{ background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08); border-radius:24px; box-shadow: 0 20px 60px rgba(0,0,0,.35);
      overflow:hidden; backdrop-filter: blur(3px); }
    .dx-header{ padding:18px 22px; display:flex; flex-wrap:wrap; align-items:center; gap:14px;
      border-bottom:1px solid rgba(255,255,255,.08); background: linear-gradient(90deg, rgba(91,140,255,.18), rgba(0,194,168,.12)); }
    .dx-badge{ font-weight:700; letter-spacing:.3px; background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12); padding:8px 12px; border-radius:999px; }
    .dx-title{ font-size:18px; color:#dfe8ff }
    .dx-progress{ height:8px; background:rgba(255,255,255,.08); position:relative; width:100%; border-radius:999px; overflow:hidden;}
    .dx-progress > span{ position:absolute; inset:0 0 0 auto; width:0%;
      background: linear-gradient(90deg, var(--primary), var(--accent)); transition: width .35s ease; }
    .dx-pre{ padding:16px 22px; display:flex; gap:12px; align-items:center;
      border-bottom:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.02);}
    .dx-pre label{ color:#cbd6ff; }
    .dx-pre input{ background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.12);
      color:#fff; padding:10px 12px; border-radius:12px; outline:none; flex:1;}
    .dx-step{ display:none; padding:24px 22px 8px 22px; animation: fade .25s ease; }
    .dx-step.active{ display:block; }
    .dx-q{ font-size:20px; line-height:1.35; margin:12px 0 18px; color:#fff; }
    .dx-help{ color:var(--muted); font-size:14px; margin:-6px 0 14px; }
    .options{ display:grid; gap:10px; }
    .opt{ background: rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1);
      padding:12px 14px; border-radius:14px; display:flex; align-items:center; gap:10px; cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease; }
    .opt:hover{ transform:translateY(-1px); background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.2); }
    .opt input{ transform:scale(1.1); accent-color: var(--accent); }
    .dx-footer{ display:flex; justify-content:space-between; align-items:center; gap:12px;
      padding:18px 22px 24px; border-top:1px solid rgba(255,255,255,.08); }
    .btn-dx{ appearance:none; border:none; cursor:pointer; font-weight:700; padding:12px 18px; border-radius:14px;
      color:#08111f; background:linear-gradient(90deg, #90a7ff, #61f0dd); box-shadow:0 8px 24px rgba(0,0,0,.25);}
    .btn-dx.secondary{ background:transparent; color:#cbd6ff; border:1px solid rgba(255,255,255,.18); box-shadow:none; }
    .btn-dx:disabled{ opacity:.5; cursor:not-allowed }
    .dx-toast{ color:#ffd9d9; font-size:14px; display:none; }
    .dx-toast.show{ display:block; }
    button.disabled{ opacity:.6; pointer-events:none; }

    .dx-results{ display:none; padding:22px; }
    .dx-grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); margin:14px 0 10px; }
    .dx-kpi{ background: rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:14px; }
    .dx-kpi h4{ margin:0 0 6px; font-size:14px; color:#bcd0ff; font-weight:600 }
    .dx-kpi .val{ font-size:26px; font-weight:800 }
    .tag{ font-size:12px; font-weight:700; padding:4px 10px; border-radius:999px; }
    .tag.bad{ background:rgba(231,76,60,.2); border:1px solid rgba(231,76,60,.5); color:#f7b4ad }
    .tag.warn{ background:rgba(243,156,18,.2); border:1px solid rgba(243,156,18,.5); color:#ffdeab }
    .tag.ok{ background:rgba(46,204,113,.2); border:1px solid rgba(46,204,113,.5); color:#c2f3d5 }

    /* Reporte */
    #dxReport{ margin-top:18px; background:#fff; color:#1f2a44; border-radius:16px; padding:0; overflow:hidden;
      box-shadow: 0 16px 44px rgba(0,0,0,.35); position:relative; }
    .rep-cover{
      background: linear-gradient(135deg, rgba(37,51,89,.92), rgba(0,194,168,.7)), var(--lib1);
      background-size: cover; background-position:center; color:#fff; padding:22px;
      display:flex; align-items:center; justify-content:space-between; gap:18px;
    }
    .rep-title h2{ margin:0 0 6px; font-size:22px; }
    .rep-title .subtitle{ margin:0; font-size:14px; opacity:.9 }
    .legend{ font-size:12px; color:#e5e9ff }
    .legend .pill{ margin-right:8px; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.35); background:rgba(255,255,255,.12); }
    .pill.bad{ background:#b52828; color:#fff; border-color:#eaa; }
    .pill.warn{ background:#8a5a00; color:#fff; border-color:#ffd38b; }
    .pill.ok{ background:#1b7a3c; color:#fff; border-color:#c2f3d5; }
    .gaugeWrap{ display:flex; gap:10px; align-items:center; }
    #gaugeGlobal{ width:120px; height:120px; filter: drop-shadow(0 6px 14px rgba(0,0,0,.25)); }
    .gaugeMeta .score{ font-size:26px; font-weight:800; margin:4px 0; color:#fff }
    .gaugeMeta .pill{ border-color:rgba(255,255,255,.35) }
    .rep-body{ padding:18px 22px; background:
      radial-gradient(1200px 800px at 120% -20%, rgba(0,194,168,.08), transparent 35%),
      radial-gradient(1000px 700px at -10% 0%, rgba(91,140,255,.08), transparent 40%),
      #ffffff; }
    .rep-section{ margin-top:16px; }
    .rep-section h3{ margin:0 0 6px; font-size:18px; color:var(--repAccent) }
    .rep-section p{ margin:0 0 6px; }
    .card-grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); }
    .card{ background:#f7f9ff; border:1px solid #e6ebff; border-radius:12px; padding:12px; }
    #chart, #barrierChart{ width:100%; height:240px; margin:12px 0 6px; }
    table.rep{ width:100%; border-collapse:collapse; margin:8px 0 14px; font-size:14px; }
    table.rep th, table.rep td{ border:1px solid #e6e6e6; padding:8px 10px; }
    table.rep th{ background:#eef2ff; text-align:left; color:#2a3763 }
    .rep-bad{ color:#e74c3c; font-weight:700 } .rep-warn{ color:#f39c12; font-weight:700 } .rep-ok{ color:#27ae60; font-weight:700 }
    .rep-actions{ display:flex; gap:10px; margin:10px 0 0; }
    .btn-ghost{ background:#eaf2ff; color:#213; border:1px solid #d4e2ff; border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer; }

    .timeline{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); }
    .tcol{ background:#fff; border:1px solid #e8ebf5; border-radius:12px; padding:12px; }
    .tcol h4{ margin:0 0 6px; color:#203054 }
    .tcol ul{ margin:0; padding-left:18px; }
    .chip{ display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid #ddd; margin-right:6px; }
    .chip.eco{ background:#fff5e6; color:#8a5a00; border-color:#f8d7a0 }
    .chip.tec{ background:#eaf4ff; color:#114a92; border-color:#cfe2ff }
    .chip.cul{ background:#f4eaff; color:#5a2b9d; border-color:#e0ccff }

    @keyframes fade { from{opacity:.3; transform:translateY(6px)} to{opacity:1; transform:none} }
  </style>

  <div class="dx-container">
    <div class="dx-card" id="dxCard">
      <!-- HEADER -->
      <div class="dx-header">
        <span class="dx-badge" id="dimBadge">Dimensi√≥n 1 ¬∑ Tecnolog√≠a y habilidades digitales</span>
        <div class="dx-title" id="qTitle">Pregunta 1 de 25</div>
        <div class="dx-progress" aria-hidden="true"><span id="bar"></span></div>
      </div>

      <!-- PRE: Empresa -->
      <div class="dx-pre">
        <label for="empresaDx"><small>Nombre de la empresa</small></label>
        <input id="empresaDx" placeholder="Ej: AVSA S.A." readonly>
      </div>

      <!-- ====== PREGUNTAS (25) ====== -->
      <form id="dxForm">
        <!-- D1.1 -->
        <div class="dx-step active" data-item-id="D1.1" data-dim="D1" data-type="multi" data-none="Ninguna">
          <div class="dx-q">¬øQu√© <b>fuentes de formaci√≥n digital</b> utiliza su empresa actualmente? <span class="dx-help">(Puede seleccionar varias)</span></div>
          <div class="options">
            <label class="opt"><input type="checkbox" name="D1.1" value="SENA / MinTIC"> SENA / MinTIC</label>
            <label class="opt"><input type="checkbox" name="D1.1" value="C√°maras / Gremios"> C√°maras / Gremios</label>
            <label class="opt"><input type="checkbox" name="D1.1" value="Proveedores de software"> Proveedores de software</label>
            <label class="opt"><input type="checkbox" name="D1.1" value="Universidades / MOOCs (Coursera, edX)"> Universidades / MOOCs (Coursera, edX)</label>
            <label class="opt"><input type="checkbox" name="D1.1" value="YouTube / Autoformaci√≥n guiada"> YouTube / Autoformaci√≥n guiada</label>
            <label class="opt"><input type="checkbox" name="D1.1" value="Ninguna" data-none> Ninguna</label>
          </div>
        </div>
        <!-- D1.2 -->
        <div class="dx-step" data-item-id="D1.2" data-dim="D1" data-type="singleMap">
          <div class="dx-q">En los √∫ltimos 12 meses, ¬øcu√°ntas <b>horas de formaci√≥n digital</b> realiz√≥ en promedio cada empleado?</div>
          <div class="options">
            <label class="opt"><input type="radio" name="D1.2" value="0"> 0</label>
            <label class="opt"><input type="radio" name="D1.2" value="1‚Äì5"> 1‚Äì5</label>
            <label class="opt"><input type="radio" name="D1.2" value="6‚Äì10"> 6‚Äì10</label>
            <label class="opt"><input type="radio" name="D1.2" value="11‚Äì20"> 11‚Äì20</label>
            <label class="opt"><input type="radio" name="D1.2" value=">20"> &gt;20</label>
          </div>
        </div>
        <!-- D1.3 -->
        <div class="dx-step" data-item-id="D1.3" data-dim="D1" data-type="multi" data-none="Ninguna">
          <div class="dx-q">¬øQu√© <b>pr√°cticas de ciberseguridad</b> est√°n activas en su empresa? <span class="dx-help">(Puede seleccionar varias)</span></div>
          <div class="options">
            <label class="opt"><input type="checkbox" name="D1.3" value="Contrase√±as robustas / pol√≠tica de caducidad"> Contrase√±as robustas / pol√≠tica de caducidad</label>
            <label class="opt"><input type="checkbox" name="D1.3" value="Autenticaci√≥n de dos factores (2FA)"> Autenticaci√≥n de dos factores (2FA)</label>
            <label class="opt"><input type="checkbox" name="D1.3" value="Antivirus/EDR y parches autom√°ticos"> Antivirus/EDR y parches autom√°ticos</label>
            <label class="opt"><input type="checkbox" name="D1.3" value="Pol√≠ticas de acceso por roles"> Pol√≠ticas de acceso por roles</label>
            <label class="opt"><input type="checkbox" name="D1.3" value="Copias de seguridad 3-2-1"> Copias de seguridad 3-2-1</label>
            <label class="opt"><input type="checkbox" name="D1.3" value="Formaci√≥n anti-phishing"> Formaci√≥n anti-phishing</label>
            <label class="opt"><input type="checkbox" name="D1.3" value="Ninguna" data-none> Ninguna</label>
          </div>
        </div>
        <!-- D1.4 -->
        <div class="dx-step" data-item-id="D1.4" data-dim="D1" data-type="singleMap">
          <div class="dx-q">¬øCu√°l es la <b>antig√ºedad promedio</b> del hardware principal (PCs/servidores)?</div>
          <div class="options">
            <label class="opt"><input type="radio" name="D1.4" value="<3 a√±os"> &lt;3 a√±os</label>
            <label class="opt"><input type="radio" name="D1.4" value="3‚Äì5 a√±os"> 3‚Äì5 a√±os</label>
            <label class="opt"><input type="radio" name="D1.4" value=">5 a√±os"> &gt;5 a√±os</label>
          </div>
        </div>
        <!-- D1.5 -->
        <div class="dx-step" data-item-id="D1.5" data-dim="D1" data-type="likert">
          <div class="dx-q">La <b>conectividad a Internet</b> es estable (&gt;95% disponibilidad) y suficiente para las operaciones.</div>
          <div class="options">
            <label class="opt"><input type="radio" name="D1.5" value="Totalmente en desacuerdo"> Totalmente en desacuerdo</label>
            <label class="opt"><input type="radio" name="D1.5" value="En desacuerdo"> En desacuerdo</label>
            <label class="opt"><input type="radio" name="D1.5" value="Neutral"> Neutral</label>
            <label class="opt"><input type="radio" name="D1.5" value="De acuerdo"> De acuerdo</label>
            <label class="opt"><input type="radio" name="D1.5" value="Totalmente de acuerdo"> Totalmente de acuerdo</label>
          </div>
        </div>

        <!-- D2 -->
        <div class="dx-step" data-item-id="D2.1" data-dim="D2" data-type="multi">
          <div class="dx-q">¬øQu√© <b>herramientas de comunicaci√≥n y gesti√≥n</b> usan de forma habitual? <span class="dx-help">(Puede seleccionar varias)</span></div>
          <div class="options">
            <label class="opt"><input type="checkbox" name="D2.1" value="Correo corporativo"> Correo corporativo</label>
            <label class="opt"><input type="checkbox" name="D2.1" value="Chat corporativo (Teams, Slack, etc.)"> Chat corporativo (Teams, Slack, etc.)</label>
            <label class="opt"><input type="checkbox" name="D2.1" value="Intranet / Gestor documental"> Intranet / Gestor documental</label>
            <label class="opt"><input type="checkbox" name="D2.1" value="CRM integrado"> CRM integrado</label>
          </div>
        </div>
        <div class="dx-step" data-item-id="D2.2" data-dim="D2" data-type="likert">
          <div class="dx-q">Contamos con un <b>CRM integrado</b> a marketing y ventas para leads, oportunidades y conversiones.</div>
          <div class="options">
            <label class="opt"><input type="radio" name="D2.2" value="Totalmente en desacuerdo"> Totalmente en desacuerdo</label>
            <label class="opt"><input type="radio" name="D2.2" value="En desacuerdo"> En desacuerdo</label>
            <label class="opt"><input type="radio" name="D2.2" value="Neutral"> Neutral</label>
            <label class="opt"><input type="radio" name="D2.2" value="De acuerdo"> De acuerdo</label>
            <label class="opt"><input type="radio" name="D2.2" value="Totalmente de acuerdo"> Totalmente de acuerdo</label>
          </div>
        </div>
        <div class="dx-step" data-item-id="D2.3" data-dim="D2" data-type="freq">
          <div class="dx-q">Medimos <b>NPS/CSAT</b> en canales digitales y actuamos sobre los hallazgos.</div>
          <div class="options">
            <label class="opt"><input type="radio" name="D2.3" value="Nunca"> Nunca</label>
            <label class="opt"><input type="radio" name="D2.3" value="Rara vez"> Rara vez</label>
            <label class="opt"><input type="radio" name="D2.3" value="A veces"> A veces</label>
            <label class="opt"><input type="radio" name="D2.3" value="Frecuentemente"> Frecuentemente</label>
            <label class="opt"><input type="radio" name="D2.3" value="Siempre"> Siempre</label>
          </div>
        </div>

        <!-- D3 -->
        <div class="dx-step" data-item-id="D3.1" data-dim="D3" data-type="freq">
          <div class="dx-q">Existe un <b>comit√© o reuni√≥n formal</b> sobre transformaci√≥n digital con seguimiento de acuerdos.</div>
          <div class="options">
            <label class="opt"><input type="radio" name="D3.1" value="Nunca"> Nunca</label>
            <label class="opt"><input type="radio" name="D3.1" value="Rara vez"> Rara vez</label>
            <label class="opt"><input type="radio" name="D3.1" value="A veces"> A veces</label>
            <label class="opt"><input type="radio" name="D3.1" value="Frecuentemente"> Frecuentemente</label>
            <label class="opt"><input type="radio" name="D3.1" value="Siempre"> Siempre</label>
          </div>
        </div>
        <div class="dx-step" data-item-id="D3.2" data-dim="D3" data-type="likert">
          <div class="dx-q">Contamos con un <b>plan anual de formaci√≥n digital</b> con metas por √°rea y seguimiento peri√≥dico.</div>
          <div class="options">
            <label class="opt"><input type="radio" name="D3.2" value="Totalmente en desacuerdo"> Totalmente en desacuerdo</label>
            <label class="opt"><input type="radio" name="D3.2" value="En desacuerdo"> En desacuerdo</label>
            <label class="opt"><input type="radio" name="D3.2" value="Neutral"> Neutral</label>
            <label class="opt"><input type="radio" name="D3.2" value="De acuerdo"> De acuerdo</label>
            <label class="opt"><input type="radio" name="D3.2" value="Totalmente de acuerdo"> Totalmente de acuerdo</label>
          </div>
        </div>
        <div class="dx-step" data-item-id="D3.3" data-dim="D3" data-type="likert">
          <div class="dx-q">Se promueve la <b>innovaci√≥n con ‚Äúfallo seguro‚Äù</b> (presupuestos peque√±os, ciclos cortos y m√©tricas claras).</div>
          <div class="options">
            <label class="opt"><input type="radio" name="D3.3" value="Totalmente en desacuerdo"> Totalmente en desacuerdo</label>
            <label class="opt"><input type="radio" name="D3.3" value="En desacuerdo"> En desacuerdo</label>
            <label class="opt"><input type="radio" name="D3.3" value="Neutral"> Neutral</label>
            <label class="opt"><input type="radio" name="D3.3" value="De acuerdo"> De acuerdo</label>
            <label class="opt"><input type="radio" name="D3.3" value="Totalmente de acuerdo"> Totalmente de acuerdo</label>
          </div>
        </div>
        <div class="dx-step" data-item-id="D3.4" data-dim="D3" data-type="likert">
          <div class="dx-q">Usamos <b>plataformas colaborativas</b> (documentos compartidos, tableros, tareas) en el trabajo diario.</div>
          <div class="options">
            <label class="opt"><input type="radio" name="D3.4" value="Totalmente en desacuerdo"> Totalmente en desacuerdo</label>
            <label class="opt"><input type="radio" name="D3.4" value="En desacuerdo"> En desacuerdo</label>
            <label class="opt"><input type="radio" name="D3.4" value="Neutral"> Neutral</label>
            <label class="opt"><input type="radio" name="D3.4" value="De acuerdo"> De acuerdo</label>
            <label class="opt"><input type="radio" name="D3.4" value="Totalmente de acuerdo"> Totalmente de acuerdo</label>
          </div>
        </div>
        <div class="dx-step" data-item-id="D3.5" data-dim="D3" data-type="singleMap">
          <div class="dx-q">¬øCu√°l es su <b>relaci√≥n con asesores externos</b> en temas digitales?</div>
          <div class="options">
            <label class="opt"><input type="radio" name="D3.5" value="Nunca"> Nunca</label>
            <label class="opt"><input type="radio" name="D3.5" value="Diagn√≥stico puntual"> Diagn√≥stico puntual</label>
            <label class="opt"><input type="radio" name="D3.5" value="Ocasional"> Ocasional</label>
            <label class="opt"><input type="radio" name="D3.5" value="Peri√≥dica/trimestral"> Peri√≥dica/trimestral</label>
            <label class="opt"><input type="radio" name="D3.5" value="Alianza estable"> Alianza estable</label>
          </div>
        </div>
        <div class="dx-step" data-item-id="D3.7" data-dim="D3" data-type="likert">
          <div class="dx-q">Existen <b>incentivos/bonos/reconocimiento</b> por adoptar y usar herramientas digitales.</div>
          <div class="options">
            <label class="opt"><input type="radio" name="D3.7" value="Totalmente en desacuerdo"> Totalmente en desacuerdo</label>
            <label class="opt"><input type="radio" name="D3.7" value="En desacuerdo"> En desacuerdo</label>
            <label class="opt"><input type="radio" name="D3.7" value="Neutral"> Neutral</label>
            <label class="opt"><input type="radio" name="D3.7" value="De acuerdo"> De acuerdo</label>
            <label class="opt"><input type="radio" name="D3.7" value="Totalmente de acuerdo"> Totalmente de acuerdo</label>
          </div>
        </div>

        <!-- D4 -->
        <div class="dx-step" data-item-id="D4.1" data-dim="D4" data-type="multi" data-none="Ninguno">
          <div class="dx-q">¬øQu√© <b>apoyos externos</b> conoce o ha usado para impulsar la digitalizaci√≥n? <span class="dx-help">(Puede seleccionar varias)</span></div>
          <div class="options">
            <label class="opt"><input type="checkbox" name="D4.1" value="C√°maras de comercio"> C√°maras de comercio</label>
            <label class="opt"><input type="checkbox" name="D4.1" value="SENA"> SENA</label>
            <label class="opt"><input type="checkbox" name="D4.1" value="MinTIC / CTD"> MinTIC / CTD</label>
            <label class="opt"><input type="checkbox" name="D4.1" value="iNNpulsa / Banc√≥ldex"> iNNpulsa / Banc√≥ldex</label>
            <label class="opt"><input type="checkbox" name="D4.1" value="Universidades / Centros de innovaci√≥n"> Universidades / Centros de innovaci√≥n</label>
            <label class="opt"><input type="checkbox" name="D4.1" value="Banca comercial / Fintech"> Banca comercial / Fintech</label>
            <label class="opt"><input type="checkbox" name="D4.1" value="Alcald√≠a / Gobernaci√≥n"> Alcald√≠a / Gobernaci√≥n</label>
            <label class="opt"><input type="checkbox" name="D4.1" value="Ninguno" data-none> Ninguno</label>
          </div>
        </div>
        <div class="dx-step" data-item-id="D4.2" data-dim="D4" data-type="likert">
          <div class="dx-q">Monitoreamos y aplicamos a <b>incentivos/subsidios</b> relevantes para la transformaci√≥n digital.</div>
          <div class="options">
            <label class="opt"><input type="radio" name="D4.2" value="Totalmente en desacuerdo"> Totalmente en desacuerdo</label>
            <label class="opt"><input type="radio" name="D4.2" value="En desacuerdo"> En desacuerdo</label>
            <label class="opt"><input type="radio" name="D4.2" value="Neutral"> Neutral</label>
            <label class="opt"><input type="radio" name="D4.2" value="De acuerdo"> De acuerdo</label>
            <label class="opt"><input type="radio" name="D4.2" value="Totalmente de acuerdo"> Totalmente de acuerdo</label>
          </div>
        </div>
        <div class="dx-step" data-item-id="D4.3" data-dim="D4" data-type="singleMap">
          <div class="dx-q">¬øQu√© <b>porcentaje del presupuesto anual</b> se destina a iniciativas de transformaci√≥n digital?</div>
          <div class="options">
            <label class="opt"><input type="radio" name="D4.3" value="0%"> 0%</label>
            <label class="opt"><input type="radio" name="D4.3" value="1‚Äì2%"> 1‚Äì2%</label>
            <label class="opt"><input type="radio" name="D4.3" value="3‚Äì5%"> 3‚Äì5%</label>
            <label class="opt"><input type="radio" name="D4.3" value="6‚Äì10%"> 6‚Äì10%</label>
            <label class="opt"><input type="radio" name="D4.3" value=">10%"> &gt;10%</label>
          </div>
        </div>
        <div class="dx-step" data-item-id="D4.4" data-dim="D4" data-type="freq">
          <div class="dx-q">Exploramos <b>soluciones de bajo costo</b> (open source / freemium) antes de invertir.</div>
          <div class="options">
            <label class="opt"><input type="radio" name="D4.4" value="Nunca"> Nunca</label>
            <label class="opt"><input type="radio" name="D4.4" value="Rara vez"> Rara vez</label>
            <label class="opt"><input type="radio" name="D4.4" value="A veces"> A veces</label>
            <label class="opt"><input type="radio" name="D4.4" value="Frecuentemente"> Frecuentemente</label>
            <label class="opt"><input type="radio" name="D4.4" value="Siempre"> Siempre</label>
          </div>
        </div>
        <div class="dx-step" data-item-id="D4.5" data-dim="D4" data-type="multi" data-none="Ninguno">
          <div class="dx-q">¬øQu√© <b>criterios</b> utiliza para priorizar proyectos digitales? <span class="dx-help">(Puede seleccionar varias)</span></div>
          <div class="options">
            <label class="opt"><input type="checkbox" name="D4.5" value="ROI esperado"> ROI esperado</label>
            <label class="opt"><input type="checkbox" name="D4.5" value="Impacto en la experiencia del cliente"> Impacto en la experiencia del cliente</label>
            <label class="opt"><input type="checkbox" name="D4.5" value="Eficiencia / ahorro operativo"> Eficiencia / ahorro operativo</label>
            <label class="opt"><input type="checkbox" name="D4.5" value="Cumplimiento normativo"> Cumplimiento normativo</label>
            <label class="opt"><input type="checkbox" name="D4.5" value="Gesti√≥n de riesgos"> Gesti√≥n de riesgos</label>
            <label class="opt"><input type="checkbox" name="D4.5" value="Alineaci√≥n estrat√©gica"> Alineaci√≥n estrat√©gica</label>
            <label class="opt"><input type="checkbox" name="D4.5" value="Ninguno" data-none> Ninguno</label>
          </div>
        </div>
        <div class="dx-step" data-item-id="D4.6" data-dim="D4" data-type="singleMap">
          <div class="dx-q">¬øCu√°l es su <b>pol√≠tica frente a tecnolog√≠as emergentes</b> (IA, IoT, etc.)?</div>
          <div class="options">
            <label class="opt"><input type="radio" name="D4.6" value="No se consideran"> No se consideran</label>
            <label class="opt"><input type="radio" name="D4.6" value="Solo est√°ndar"> Solo est√°ndar</label>
            <label class="opt"><input type="radio" name="D4.6" value="Pilotos ocasionales"> Pilotos ocasionales</label>
            <label class="opt"><input type="radio" name="D4.6" value="Pilotos controlados"> Pilotos controlados</label>
            <label class="opt"><input type="radio" name="D4.6" value="Adopci√≥n temprana"> Adopci√≥n temprana</label>
          </div>
        </div>

        <!-- D5 -->
        <div class="dx-step" data-item-id="D5.1" data-dim="D5" data-type="likert">
          <div class="dx-q">Realizamos <b>an√°lisis costo‚Äìbeneficio</b> antes e <b>indicadores/ROI</b> despu√©s de implementar proyectos digitales.</div>
          <div class="options">
            <label class="opt"><input type="radio" name="D5.1" value="Totalmente en desacuerdo"> Totalmente en desacuerdo</label>
            <label class="opt"><input type="radio" name="D5.1" value="En desacuerdo"> En desacuerdo</label>
            <label class="opt"><input type="radio" name="D5.1" value="Neutral"> Neutral</label>
            <label class="opt"><input type="radio" name="D5.1" value="De acuerdo"> De acuerdo</label>
            <label class="opt"><input type="radio" name="D5.1" value="Totalmente de acuerdo"> Totalmente de acuerdo</label>
          </div>
        </div>
        <div class="dx-step" data-item-id="D5.2" data-dim="D5" data-type="likert">
          <div class="dx-q">Las inversiones digitales han generado <b>mejoras medibles</b> (ventas, costos, tiempos, satisfacci√≥n).</div>
          <div class="options">
            <label class="opt"><input type="radio" name="D5.2" value="Totalmente en desacuerdo"> Totalmente en desacuerdo</label>
            <label class="opt"><input type="radio" name="D5.2" value="En desacuerdo"> En desacuerdo</label>
            <label class="opt"><input type="radio" name="D5.2" value="Neutral"> Neutral</label>
            <label class="opt"><input type="radio" name="D5.2" value="De acuerdo"> De acuerdo</label>
            <label class="opt"><input type="radio" name="D5.2" value="Totalmente de acuerdo"> Totalmente de acuerdo</label>
          </div>
        </div>
        <div class="dx-step" data-item-id="D5.3" data-dim="D5" data-type="multi" data-none="Ninguna">
          <div class="dx-q">¬øQu√© pr√°cticas de <b>seguridad y calidad de datos</b> est√°n implementadas? <span class="dx-help">(Puede seleccionar varias)</span></div>
          <div class="options">
            <label class="opt"><input type="checkbox" name="D5.3" value="Pol√≠ticas de acceso / roles"> Pol√≠ticas de acceso / roles</label>
            <label class="opt"><input type="checkbox" name="D5.3" value="Backups 3-2-1"> Backups 3-2-1</label>
            <label class="opt"><input type="checkbox" name="D5.3" value="Encriptaci√≥n / EDR"> Encriptaci√≥n / EDR</label>
            <label class="opt"><input type="checkbox" name="D5.3" value="Capacitaci√≥n anti-phishing"> Capacitaci√≥n anti-phishing</label>
            <label class="opt"><input type="checkbox" name="D5.3" value="Procesos de calidad de datos"> Procesos de calidad de datos</label>
            <label class="opt"><input type="checkbox" name="D5.3" value="Ninguna" data-none> Ninguna</label>
          </div>
        </div>

        <!-- D6 -->
        <div class="dx-step" data-item-id="D6.1" data-dim="D6" data-type="freq">
          <div class="dx-q">Realizamos <b>pilotos / pruebas de concepto (PoC)</b> para aprender con riesgo controlado.</div>
          <div class="options">
            <label class="opt"><input type="radio" name="D6.1" value="Nunca"> Nunca</label>
            <label class="opt"><input type="radio" name="D6.1" value="Rara vez"> Rara vez</label>
            <label class="opt"><input type="radio" name="D6.1" value="A veces"> A veces</label>
            <label class="opt"><input type="radio" name="D6.1" value="Frecuentemente"> Frecuentemente</label>
            <label class="opt"><input type="radio" name="D6.1" value="Siempre"> Siempre</label>
          </div>
        </div>
        <div class="dx-step" data-item-id="D6.2" data-dim="D6" data-type="singleMap">
          <div class="dx-q">¬øCu√°l es el <b>tiempo promedio de resoluci√≥n</b> de incidentes TI (MTTR)?</div>
          <div class="options">
            <label class="opt"><input type="radio" name="D6.2" value="<4h"> &lt;4h</label>
            <label class="opt"><input type="radio" name="D6.2" value="4‚Äì24h"> 4‚Äì24h</label>
            <label class="opt"><input type="radio" name="D6.2" value="1‚Äì3 d√≠as"> 1‚Äì3 d√≠as</label>
            <label class="opt"><input type="radio" name="D6.2" value=">3 d√≠as"> &gt;3 d√≠as</label>
            <label class="opt"><input type="radio" name="D6.2" value="No medimos"> No medimos</label>
          </div>
        </div>
      </form>

      <!-- FOOTER -->
      <div class="dx-footer">
        <div class="dx-toast" id="toast">Por favor, responde la pregunta para continuar.</div>
        <div style="display:flex; gap:10px; margin-left:auto;">
          <button class="btn-dx secondary" id="btnPrev" type="button">‚üµ Atr√°s</button>
          <button class="btn-dx" id="btnNext" type="button">Siguiente ‚ü∂</button>
        </div>
      </div>

      <!-- RESULTADOS + INFORME -->
      <div class="dx-results" id="dxResults">
        <h3 style="margin:0 0 6px">Resultados del Autodiagn√≥stico</h3>
        <button type="button" class="btn-dx secondary" id="btnInicio" style="margin:6px 0 8px">Inicio</button>
        <p class="dx-help">Promedio 1‚Äì5 por dimensi√≥n. <i>(Bajo &lt; 2.5 ¬∑ Intermedio 2.5‚Äì3.9 ¬∑ Avanzado ‚â• 4.0)</i></p>
        <div class="dx-grid" id="gridDim"></div>
        <div class="dx-kpi">
          <h4>Nivel Global</h4>
          <div class="val" id="globalVal">‚Äì</div>
          <span id="globalTag" class="tag">‚Äì</span>
        </div>

        <div id="dxReport">
          <div class="rep-cover">
            <div class="rep-title">
              <h2>Informe de Autodiagn√≥stico</h2>
              <p class="subtitle">Empresa: <span id="repEmpresa">‚Äì</span> ¬∑ Fecha: <span id="repFecha">‚Äì</span></p>
              <div class="legend">
                <span class="pill bad">Bajo &lt; 2.5</span>
                <span class="pill warn">Intermedio 2.5‚Äì3.9</span>
                <span class="pill ok">Avanzado ‚â• 4.0</span>
              </div>
            </div>
            <div class="gaugeWrap">
              <div id="gaugeGlobal"></div>
              <div class="gaugeMeta">
                <div class="score" id="gScore">‚Äì</div>
                <span id="gLevel" class="pill">‚Äì</span>
              </div>
            </div>
          </div>

          <div class="rep-body">
            <div class="rep-section" id="repExec"></div>

            <div class="rep-section">
              <h3>Desempe√±o por Dimensi√≥n</h3>
              <div id="chart"></div>
            </div>
            <div class="rep-section">
              <h3>Desempe√±o por Barrera</h3>
              <div id="barrierChart"></div>
              <p style="font-size:12px;color:#5a677f;margin:4px 0 0">
                Nota: Las barreras se calculan con subconjuntos de √≠tems (Econ√≥micas, Tecnol√≥gicas y Culturales) para orientar la hoja de ruta.
              </p>
            </div>

            <div class="rep-section">
              <div class="card">
                <h3>Tabla por Dimensi√≥n</h3>
                <table class="rep" id="repTable">
                  <thead><tr><th>Dimensi√≥n</th><th>Promedio</th><th>Nivel</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="rep-section" id="repDeep"></div>

            <div class="rep-section">
              <h3>Hoja de Ruta Recomendada</h3>
              <div class="timeline" id="repRoadmap"></div>
            </div>

            <div class="rep-actions">
              <button class="btn-ghost" type="button" onclick="downloadPDF()"><i class="bi bi-download me-1"></i> Descargar PDF</button>
            </div>
          </div>
        </div>
      </div><!-- /dx-results -->

    </div>
  </div>

  <script>
    // ====== PUNTAJE ======
    const MAP = {
      LIKERT: {"Totalmente en desacuerdo":1,"En desacuerdo":2,"Neutral":3,"De acuerdo":4,"Totalmente de acuerdo":5},
      FREQ: {"Nunca":1,"Rara vez":2,"A veces":3,"Frecuentemente":4,"Siempre":5}
    };
    const ITEMS = [
      // D1
      {id:"D1.1", dim:"D1", type:"multi", none:"Ninguna", cap:5},
      {id:"D1.2", dim:"D1", type:"singleMap", map:{"0":1,"1‚Äì5":2,"6‚Äì10":3,"11‚Äì20":4,">20":5}},
      {id:"D1.3", dim:"D1", type:"multi", none:"Ninguna", cap:5},
      {id:"D1.4", dim:"D1", type:"singleMap", map:{">5 a√±os":1,"3‚Äì5 a√±os":3,"<3 a√±os":5}},
      {id:"D1.5", dim:"D1", type:"likert"},
      // D2
      {id:"D2.1", dim:"D2", type:"multi", cap:5},
      {id:"D2.2", dim:"D2", type:"likert"},
      {id:"D2.3", dim:"D2", type:"freq"},
      // D3
      {id:"D3.1", dim:"D3", type:"freq"},
      {id:"D3.2", dim:"D3", type:"likert"},
      {id:"D3.3", dim:"D3", type:"likert"},
      {id:"D3.4", dim:"D3", type:"likert"},
      {id:"D3.5", dim:"D3", type:"singleMap", map:{"Nunca":1,"Diagn√≥stico puntual":2,"Ocasional":3,"Peri√≥dica/trimestral":4,"Alianza estable":5}},
      {id:"D3.7", dim:"D3", type:"likert"},
      // D4
      {id:"D4.1", dim:"D4", type:"multi", none:"Ninguno", cap:5},
      {id:"D4.2", dim:"D4", type:"likert"},
      {id:"D4.3", dim:"D4", type:"singleMap", map:{"0%":1,"1‚Äì2%":2,"3‚Äì5%":3,"6‚Äì10%":4,">10%":5}},
      {id:"D4.4", dim:"D4", type:"freq"},
      {id:"D4.5", dim:"D4", type:"multi", none:"Ninguno", cap:5},
      {id:"D4.6", dim:"D4", type:"singleMap", map:{"No se consideran":1,"Solo est√°ndar":2,"Pilotos ocasionales":3,"Pilotos controlados":4,"Adopci√≥n temprana":5}},
      // D5
      {id:"D5.1", dim:"D5", type:"likert"},
      {id:"D5.2", dim:"D5", type:"likert"},
      {id:"D5.3", dim:"D5", type:"multi", none:"Ninguna", cap:5},
      // D6
      {id:"D6.1", dim:"D6", type:"freq"},
      {id:"D6.2", dim:"D6", type:"singleMap", map:{"<4h":5,"4‚Äì24h":4,"1‚Äì3 d√≠as":3,">3 d√≠as":2,"No medimos":1}},
    ];
    const DIM_NAMES = {
      D1:"Dimensi√≥n 1 ¬∑ Tecnolog√≠a y habilidades digitales",
      D2:"Dimensi√≥n 2 ¬∑ Comunicaciones y canales de venta",
      D3:"Dimensi√≥n 3 ¬∑ Organizaci√≥n y personas",
      D4:"Dimensi√≥n 4 ¬∑ Estrategia y transformaci√≥n digital",
      D5:"Dimensi√≥n 5 ¬∑ Datos y anal√≠tica",
      D6:"Dimensi√≥n 6 ¬∑ Procesos"
    };
    const BARRIERS = {
      ECO: { label: "Econ√≥micas", items: ["D4.1","D4.2","D4.3","D4.4","D4.5","D5.1","D4.6","D6.1","D5.2"] },
      TEC: { label: "Tecnol√≥gicas", items: ["D1.1","D1.2","D1.3","D5.3","D1.4","D1.5","D2.1","D2.2","D2.3","D6.2"] },
      CUL: { label: "Culturales", items: ["D3.1","D3.2","D3.3","D3.4","D3.5","D3.7"] }
    };
    const LEVEL = x => (x>=4.0) ? "Avanzado" : (x>=2.5 ? "Intermedio" : "Bajo");
    const levelClass = lvl => (lvl==="Bajo" ? "rep-bad" : (lvl==="Intermedio" ? "rep-warn" : "rep-ok"));

    // ====== NAVEGACI√ìN ======
    const steps = Array.from(document.querySelectorAll('.dx-step'));
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const toast = document.getElementById('toast');
    const bar = document.getElementById('bar');
    const qTitle = document.getElementById('qTitle');
    const dimBadge = document.getElementById('dimBadge');
    const resultsEl = document.getElementById('dxResults');
    const gridDim = document.getElementById('gridDim');
    const btnInicio = document.getElementById('btnInicio');

    /* ===== Bloqueo del cuestionario ===== */
    let dxLocked = false;
    function lockDx(){
      dxLocked = true;
      if (btnPrev){ btnPrev.disabled = true; btnPrev.classList.add('disabled'); }
      if (btnNext){
        btnNext.disabled = true;
        btnNext.classList.add('disabled');
        btnNext.textContent = 'Diagn√≥stico finalizado';
      }
      document.querySelectorAll('#dxForm input').forEach(i => i.disabled = true);
    }
    function unlockDx(){
      dxLocked = false;
      if (btnPrev){ btnPrev.disabled = false; btnPrev.classList.remove('disabled'); }
      if (btnNext){
        btnNext.disabled = false;
        btnNext.classList.remove('disabled');
        btnNext.textContent = 'Siguiente ‚ü∂';
      }
      document.querySelectorAll('#dxForm input').forEach(i => i.disabled = false);
    }
    function startNewDx(){
      unlockDx();
      try{ document.getElementById('dxForm').reset(); }catch{}
      document.querySelectorAll('#dxForm input[type="checkbox"],#dxForm input[type="radio"]').forEach(i=>{ i.checked=false; });
      const edx = document.getElementById('empresaDx');
      if (edx) edx.value = window.currentCompany || '';
      idx = 0; showStep(0);
      resultsEl.style.display = 'none';
    }

    if(btnInicio){
      btnInicio.addEventListener('click', ()=>{
        if(window.currentEmail){
          showOnly(prevResultsSection);
          loadPreviousResults?.();
        }else{
          showOnly(landing);
        }
      });
    }

    let idx = 0; updateHeader();

    // ‚ÄúNinguna/Ninguno‚Äù exclusiva
    document.getElementById('dxForm').addEventListener('change', (e)=>{
      const cb = e.target;
      if(cb.type==='checkbox' && cb.dataset.none!==undefined){
        const group = Array.from(document.getElementsByName(cb.name));
        if(cb.checked){ group.forEach(el=>{ if(el!==cb) el.checked=false; }); }
      } else if(cb.type==='checkbox'){
        const group = Array.from(document.getElementsByName(cb.name));
        const none = group.find(el=> el.dataset.none!==undefined);
        if(none && cb.checked){ none.checked=false; }
      }
    });

    // ATR√ÅS (bloquea si finalizado)
    btnPrev.addEventListener('click', ()=>{
      if (dxLocked) return;
      if(idx>0){ idx--; showStep(idx); }
    });

    // SIGUIENTE / FINALIZAR (bloquea si finalizado)
    btnNext.addEventListener('click', ()=>{
      if (dxLocked) return;

      if(!validateStep(idx)){ toast.classList.add('show'); return; }
      toast.classList.remove('show');
      if(idx < steps.length-1){ idx++; showStep(idx); }
      else{
        // FINALIZAR
        const answers = collectAnswers();
        const res = computeScores(answers);
        renderResults(res);
        const barrier = computeBarrierScores(answers);
        buildReport(res, barrier);
        if(window.saveDxResult) { window.saveDxResult(res, barrier, answers); }
        lockDx(); // ‚¨ÖÔ∏è bloquear tras finalizar
      }
    });

    function showStep(i){
      steps.forEach((s,n)=> s.classList.toggle('active', n===i));
      updateHeader();
      window.scrollTo({top:document.getElementById('dxCard').offsetTop-10, behavior:'smooth'});
    }
    function updateHeader(){
      const step = steps[idx]; const dim = step.dataset.dim; const total = steps.length;
      qTitle.textContent = `Pregunta ${idx+1} de ${total}`;
      dimBadge.textContent = DIM_NAMES[dim] || '';
      const pct = ((idx)/(total))*100; bar.style.width = pct + '%';
      btnPrev.disabled = idx===0;
      btnNext.textContent = (idx===total-1) ? 'Finalizar diagn√≥stico' : 'Siguiente ‚ü∂';
      resultsEl.style.display = 'none';
    }
    function validateStep(i){
      const step = steps[i]; const id = step.dataset.itemId; const fields = Array.from(document.getElementsByName(id));
      return fields.some(f=>f.checked);
    }

    // ====== PUNTAJE ======
    function collectAnswers(){
      const out = {};
      for(const it of ITEMS){
        const fields = Array.from(document.getElementsByName(it.id));
        if(!fields.length) continue;
        if(it.type==='multi'){ out[it.id] = fields.filter(f=>f.checked).map(f=>f.value); }
        else{ const sel = fields.find(f=>f.checked); out[it.id] = sel ? sel.value : undefined; }
      }
      return out;
    }
    function scoreItem(item, answer){
      if(item.type==="likert") return MAP.LIKERT[answer] ?? 0;
      if(item.type==="freq")   return MAP.FREQ[answer] ?? 0;
      if(item.type==="singleMap") return item.map[answer] ?? 0;
      if(item.type==="multi"){
        const arr = Array.isArray(answer) ? answer : [];
        const cleaned = arr.filter(opt => item.none ? opt!==item.none : true);
        if(arr.length===1 && item.none && arr[0]===item.none) return 1;
        return Math.min(item.cap||5, (cleaned.length || 1));
      }
      return 0;
    }
    function computeScores(answers){
      const dims = {D1:[],D2:[],D3:[],D4:[],D5:[],D6:[]};
      for(const it of ITEMS){
        const v = answers[it.id]; const s = scoreItem(it, v); dims[it.dim].push(s);
      }
      const dimAvg = {}; Object.keys(dims).forEach(k=>{
        const arr = dims[k].filter(n=>n>0); dimAvg[k] = arr.reduce((a,b)=>a+b,0)/arr.length;
      });
      const global = Object.values(dimAvg).reduce((a,b)=>a+b,0)/6;
      const levelDim = Object.fromEntries(Object.entries(dimAvg).map(([k,v])=>[k,LEVEL(v)]));
      const levelGlobal = LEVEL(global);
      return {dimAvg, levelDim, global, levelGlobal};
    }

    // ====== TARJETAS RESUMEN ======
    function renderResults({dimAvg, levelDim, global, levelGlobal}){
      bar.style.width = '100%';
      document.querySelectorAll('.dx-step').forEach(s=> s.classList.remove('active'));
      resultsEl.style.display = 'block';

      const makeTag = (lvl)=> (lvl==="Bajo") ? '<span class="tag bad">Bajo</span>' : (lvl==="Intermedio" ? '<span class="tag warn">Intermedio</span>' : '<span class="tag ok">Avanzado</span>');
      const order = ["D1","D2","D3","D4","D5","D6"];
      gridDim.innerHTML = order.map(k=>{
        const val = dimAvg[k] || 0; const lvl = levelDim[k];
        return `<div class="dx-kpi"><h4>${DIM_NAMES[k]}</h4><div class="val">${val.toFixed(2)}</div>${makeTag(lvl)}</div>`;
      }).join("");

      const gVal = document.getElementById('globalVal'); const gTag = document.getElementById('globalTag');
      gVal.textContent = global.toFixed(2);
      gTag.className = 'tag ' + (levelGlobal==="Bajo" ? 'bad' : levelGlobal==="Intermedio" ? 'warn' : 'ok');
      gTag.textContent = levelGlobal;

      dimBadge.textContent = "Resultados del Autodiagn√≥stico";
      qTitle.textContent = "Resumen de madurez digital";
    }

    // ====== REPORTE ======
    function buildReport({dimAvg, levelDim, global, levelGlobal}, barrierScoresOpt){
      const empresa = (document.getElementById('empresaDx').value || 'Empresa no especificada').trim();
      document.getElementById('repEmpresa').textContent = empresa;
      document.getElementById('repFecha').textContent = new Date().toLocaleDateString('es-CO');

      drawGauge('gaugeGlobal', global, LEVEL(global));
      document.getElementById('gScore').textContent = global.toFixed(2);
      const gLvl = LEVEL(global);
      const gLevel = document.getElementById('gLevel');
      gLevel.textContent = gLvl;
      gLevel.className = 'pill ' + (gLvl==='Bajo'?'bad':(gLvl==='Intermedio'?'warn':'ok'));

      drawBarChartSVG('chart', [
        {k:'D1', name:'Tecnolog√≠a y habilidades', v:dimAvg.D1},
        {k:'D2', name:'Comunicaciones y canales', v:dimAvg.D2},
        {k:'D3', name:'Organizaci√≥n y personas', v:dimAvg.D3},
        {k:'D4', name:'Estrategia y TD', v:dimAvg.D4},
        {k:'D5', name:'Datos y anal√≠tica', v:dimAvg.D5},
        {k:'D6', name:'Procesos', v:dimAvg.D6},
      ]);

      const tbody = document.querySelector('#repTable tbody');
      tbody.innerHTML = '';
      [["D1","Tecnolog√≠a y habilidades"],["D2","Comunicaciones y canales"],
       ["D3","Organizaci√≥n y personas"],["D4","Estrategia y TD"],
       ["D5","Datos y anal√≠tica"],["D6","Procesos"]].forEach(([k,label])=>{
        const val = dimAvg[k] || 0; const lvl = levelDim[k];
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${label}</td><td>${val.toFixed(2)}</td><td class="${levelClass(lvl)}">${lvl}</td>`;
        tbody.appendChild(tr);
      });

      // Barreras
      let barrierScores = barrierScoresOpt;
      if(!barrierScores){
        const answers = collectAnswers();
        barrierScores = computeBarrierScores(answers);
      }
      drawBarChartSVG('barrierChart', [
        {name:'Econ√≥micas', v:barrierScores.ECO.avg},
        {name:'Tecnol√≥gicas', v:barrierScores.TEC.avg},
        {name:'Culturales', v:barrierScores.CUL.avg}
      ]);

      document.getElementById('repExec').innerHTML = generateExecutiveSummary(dimAvg, barrierScores, global, levelDim);
      document.getElementById('repDeep').innerHTML = generateDeepAnalysis(dimAvg, levelDim, barrierScores, global);
      document.getElementById('repRoadmap').innerHTML = generateRoadmap(barrierScores, global);
    }

    // ====== CHARTS SVG ======
    function drawBarChartSVG(containerId, data){
      const el = document.getElementById(containerId); el.innerHTML = '';
      const W = el.clientWidth || 800, H = 240, pad = {l:160, r:20, t:10, b:20};
      const barH = 28, gap = 10;
      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS, 'svg'); svg.setAttribute('width', W); svg.setAttribute('height', H);
      const max = 5;
      data.forEach((row, i)=>{
        const y = pad.t + i*(barH+gap);
        const x0 = pad.l;
        const trackW = (W-pad.l-pad.r);
        const x1 = pad.l + ( trackW*(Math.max(0, Math.min(5, row.v||0))/max) );
        const bg = document.createElementNS(svgNS,'rect');
        bg.setAttribute('x', pad.l); bg.setAttribute('y', y);
        bg.setAttribute('width', trackW); bg.setAttribute('height', barH);
        bg.setAttribute('fill', '#e8eefc'); 
        svg.appendChild(bg);
        const bar = document.createElementNS(svgNS,'rect');
        bar.setAttribute('x', pad.l); bar.setAttribute('y', y);
        bar.setAttribute('width', Math.max(0, x1-x0)); bar.setAttribute('height', barH);
        bar.setAttribute('fill', '#5b8cff');
        svg.appendChild(bar);
        const tx = document.createElementNS(svgNS,'text');
        tx.setAttribute('x', 12); tx.setAttribute('y', y+barH-8);
        tx.setAttribute('fill', '#243357'); tx.setAttribute('font-size', '12'); tx.textContent = row.name;
        svg.appendChild(tx);
        const tv = document.createElementNS(svgNS,'text');
        tv.setAttribute('x', x1+6); tv.setAttribute('y', y+barH-8);
        tv.setAttribute('fill', '#243357'); tv.setAttribute('font-size', '12'); tv.textContent = (row.v||0).toFixed(2);
        svg.appendChild(tv);
      });
      el.appendChild(svg);
    }
    function drawGauge(id, score, lvl){
      const el = document.getElementById(id); el.innerHTML='';
      const size = 120, stroke = 10, r = (size - stroke)/2, c = 2*Math.PI*r;
      const pct = Math.max(0, Math.min(1, (score||0)/5));
      const offset = c*(1-pct);
      const strokeColor = (lvl==='Bajo')?'#e74c3c':(lvl==='Intermedio'?'#f39c12':'#2ecc71');
      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS,'svg'); svg.setAttribute('width', size); svg.setAttribute('height', size);
      const g = document.createElementNS(svgNS,'g'); g.setAttribute('transform', `rotate(-90 ${size/2} ${size/2})`);
      const track = document.createElementNS(svgNS,'circle');
      track.setAttribute('cx', size/2); track.setAttribute('cy', size/2); track.setAttribute('r', r);
      track.setAttribute('fill','none'); track.setAttribute('stroke','#ffffff66'); track.setAttribute('stroke-width', stroke);
      g.appendChild(track);
      const prog = document.createElementNS(svgNS,'circle');
      prog.setAttribute('cx', size/2); prog.setAttribute('cy', size/2); prog.setAttribute('r', r);
      prog.setAttribute('fill','none'); prog.setAttribute('stroke', strokeColor); prog.setAttribute('stroke-width', stroke);
      prog.setAttribute('stroke-linecap', 'round');
      prog.setAttribute('stroke-dasharray', c); prog.setAttribute('stroke-dashoffset', offset);
      g.appendChild(prog);
      svg.appendChild(g); el.appendChild(svg);
    }

    // ====== AN√ÅLISIS DIN√ÅMICO ======
    function generateExecutiveSummary(dimAvg, barrierScores, global, levelDim){
      const pairs = Object.entries(dimAvg).map(([k,v])=>({k,v})).sort((a,b)=>b.v-a.v);
      const strengths = pairs.filter(p=>p.v>=3.8).slice(0,2);
      const gaps = pairs.filter(p=>p.v<2.5).slice(0,2);
      const names = {D1:"Tecnolog√≠a y habilidades",D2:"Comunicaciones y canales",D3:"Organizaci√≥n y personas",D4:"Estrategia y TD",D5:"Datos y anal√≠tica",D6:"Procesos"};
      const gLvl = LEVEL(global);
      const sTxt = strengths.length ? strengths.map(s=>`${names[s.k]} (${s.v.toFixed(2)})`).join(" y ") : "sin fortalezas destacadas ‚â• 3.8";
      const gTxt = gaps.length ? gaps.map(s=>`${names[s.k]} (${s.v.toFixed(2)})`).join(" y ") : "sin brechas cr√≠ticas &lt; 2.5";
      const tone = gLvl==="Avanzado" ? "posici√≥n l√≠der en madurez digital con capacidades consolidadas y potencial para escalar innovaci√≥n"
                  : gLvl==="Intermedio" ? "nivel en consolidaci√≥n; hay bases s√≥lidas y oportunidades claras de estandarizaci√≥n y escalamiento"
                  : "etapa inicial; urge establecer fundamentos tecnol√≥gicos, de datos y de cultura para capturar valor";
      return `
        <div class="card-grid">
          <div class="card">
            <h3>Resumen ejecutivo</h3>
            <p>La organizaci√≥n presenta un nivel <strong>${gLvl}</strong> (${global.toFixed(2)} / 5), en <em>${tone}</em>.</p>
            <p><strong>Fortalezas:</strong> ${sTxt}.</p>
            <p><strong>Brechas prioritarias:</strong> ${gTxt}.</p>
          </div>
          <div class="card">
            <h3>Barreras (promedio)</h3>
            <p><span class="chip eco">Econ√≥micas</span> ${barrierScores.ECO.avg.toFixed(2)} ‚Äî <strong>${barrierScores.ECO.level}</strong></p>
            <p><span class="chip tec">Tecnol√≥gicas</span> ${barrierScores.TEC.avg.toFixed(2)} ‚Äî <strong>${barrierScores.TEC.level}</strong></p>
            <p><span class="chip cul">Culturales</span> ${barrierScores.CUL.avg.toFixed(2)} ‚Äî <strong>${barrierScores.CUL.level}</strong></p>
          </div>
        </div>
      `;
    }
    function generateDeepAnalysis(dimAvg, levelDim, barrierScores, global){
      const badge = lvl => lvl==='Bajo' ? '<span class="rep-bad">Bajo</span>' :
                       (lvl==='Intermedio' ? '<span class="rep-warn">Intermedio</span>' : '<span class="rep-ok">Avanzado</span>');
      const names = {D1:"Tecnolog√≠a y habilidades",D2:"Comunicaciones y canales",D3:"Organizaci√≥n y personas",D4:"Estrategia y TD",D5:"Datos y anal√≠tica",D6:"Procesos"};
      const perDim = ["D1","D2","D3","D4","D5","D6"].map(k=>{
        const v = dimAvg[k]||0, lvl = levelDim[k];
        let focus;
        if(lvl==='Bajo') focus = "Prioriza establecer pr√°cticas m√≠nimas y generar casos de valor de corto plazo.";
        else if(lvl==='Intermedio') focus = "Consolida est√°ndares, mide impacto y acelera automatizaci√≥n/anal√≠tica.";
        else focus = "Optimiza y escala; explora tecnolog√≠as emergentes con ROI controlado.";
        return `<div class="card"><h3>${names[k]}</h3><p>Puntaje: <strong>${v.toFixed(2)}</strong> ‚Äî ${badge(lvl)}</p><p>${focus}</p></div>`;
      }).join("");
      const bBlock = (label, code)=>{
        const row = barrierScores[code];
        const plan = getBarrierPlan(code, row.level);
        return `
          <div class="card">
            <h3>${label}</h3>
            <p>Puntaje: <strong>${row.avg.toFixed(2)}</strong> ‚Äî ${badge(row.level)}</p>
            <p style="margin:8px 0 4px"><em>Acciones clave inmediatas:</em></p>
            <ul>${plan.now.map(x=>`<li>${x}</li>`).join("")}</ul>
          </div>
        `;
      };
      return `
        <h3>An√°lisis por dimensi√≥n</h3>
        <div class="card-grid">${perDim}</div>
        <h3 style="margin-top:14px">An√°lisis por barrera</h3>
        <div class="card-grid">
          ${bBlock("Econ√≥micas","ECO")}
          ${bBlock("Tecnol√≥gicas","TEC")}
          ${bBlock("Culturales","CUL")}
        </div>
      `;
    }
    function getBarrierPlan(code, level){
      const ECO = {
        Bajo:{now:['<span class="chip eco">ECO</span> Identificar y postularse a apoyos (SENA, MinTIC, iNNpulsa, C√°maras).','<span class="chip eco">ECO</span> Asignar ‚â•3% del presupuesto a TD y evaluar costo‚Äìbeneficio.','<span class="chip eco">ECO</span> Definir criterios de priorizaci√≥n (ROI, cliente, riesgo) y gobernanza.'],
              mid:['<span class="chip eco">ECO</span> Portafolio con ROI trimestral y tablero financiero.','<span class="chip eco">ECO</span> Mix low-cost/open-source vs licenciamiento con TCO.','<span class="chip eco">ECO</span> Pilotos con criterios de salida y transferencia a operaci√≥n.'],
              long:['<span class="chip eco">ECO</span> Optimizar CAPEX/OPEX (SaaS vs on-prem) con m√©tricas.','<span class="chip eco">ECO</span> Escalar IA/automatizaci√≥n con ROI cerrado.','<span class="chip eco">ECO</span> Gesti√≥n de riesgos y compliance financiero/tributario.']},
        Intermedio:{now:['<span class="chip eco">ECO</span> Portafolio con ROI trimestral y tablero financiero.','<span class="chip eco">ECO</span> Estrategia TCO para compras vs. open-source.'],
                    mid:['<span class="chip eco">ECO</span> Pilotos con criterios de salida y transferencia.','<span class="chip eco">ECO</span> Automatizar control presupuestal y beneficios.'],
                    long:['<span class="chip eco">ECO</span> Optimizar CAPEX/OPEX y reinversi√≥n en innovaci√≥n.']},
        Avanzado:{now:['<span class="chip eco">ECO</span> Optimizaci√≥n CAPEX/OPEX (SaaS vs on-prem).'],mid:['<span class="chip eco">ECO</span> Escalar IA/automatizaci√≥n con ROI probado.'],long:['<span class="chip eco">ECO</span> Programa de innovaci√≥n con gesti√≥n integral de riesgos.']}
      };
      const TEC = {
        Bajo:{now:['<span class="chip tec">TEC</span> M√≠nimos de seguridad (2FA, parches, backups 3-2-1, roles).','<span class="chip tec">TEC</span> Mejorar conectividad y renovar hardware cr√≠tico.','<span class="chip tec">TEC</span> Implementar CRM b√°sico y medir NPS/CSAT; reducir MTTR.'],
              mid:['<span class="chip tec">TEC</span> Integrar CRM con marketing/ventas.','<span class="chip tec">TEC</span> Automatizar 2‚Äì3 procesos clave y tableros de BI.','<span class="chip tec">TEC</span> Fortalecer seguridad (EDR, encriptaci√≥n, capacitaci√≥n).'],
              long:['<span class="chip tec">TEC</span> Arquitectura cloud gobernada (observabilidad, IaC).','<span class="chip tec">TEC</span> IA/ML aplicada (segmentaci√≥n, forecasting).']},
        Intermedio:{now:['<span class="chip tec">TEC</span> Integrar CRM y estandarizar datos de cliente.','<span class="chip tec">TEC</span> Automatizar 2‚Äì3 procesos con KPIs.'],
                    mid:['<span class="chip tec">TEC</span> BI operativo y calidad de datos.','<span class="chip tec">TEC</span> Endurecer postura de seguridad (EDR, cifrado).'],
                    long:['<span class="chip tec">TEC</span> IA/ML y orquestaci√≥n de datos a escala.']},
        Avanzado:{now:['<span class="chip tec">TEC</span> Optimizaci√≥n de observabilidad y costos cloud.'],mid:['<span class="chip tec">TEC</span> Escalar IA/ML en journeys cr√≠ticos.'],long:['<span class="chip tec">TEC</span> Zero-Trust, SSO y respuesta a incidentes con SLAs.']}
      };
      const CUL = {
        Bajo:{now:['<span class="chip cul">CUL</span> Comit√© de TD con calendario/actas y responsables.','<span class="chip cul">CUL</span> Plan anual de formaci√≥n por rol.','<span class="chip cul">CUL</span> Incentivos por adopci√≥n y uso real.'],
              mid:['<span class="chip cul">CUL</span> Gesti√≥n del cambio y comunidades de pr√°ctica.','<span class="chip cul">CUL</span> Alianzas estables con partners.'],
              long:['<span class="chip cul">CUL</span> Innovaci√≥n abierta (retos/pilotos externos).','<span class="chip cul">CUL</span> Academia digital interna con rutas por rol.']},
        Intermedio:{now:['<span class="chip cul">CUL</span> Gesti√≥n del cambio y comunidades de pr√°ctica.','<span class="chip cul">CUL</span> OKRs de adopci√≥n y valor por equipos.'],
                    mid:['<span class="chip cul">CUL</span> Alianzas estables y coaching de liderazgo digital.'],
                    long:['<span class="chip cul">CUL</span> Programa de innovaci√≥n abierta con m√©tricas de transferencia.']},
        Avanzado:{now:['<span class="chip cul">CUL</span> Refuerzo de liderazgo digital y mentoring.'],mid:['<span class="chip cul">CUL</span> Academia digital interna escalada.'],long:['<span class="chip cul">CUL</span> Portafolio continuo de experimentaci√≥n con aprendizaje institucional.']}
      };
      const lib = (code==='ECO')?ECO:(code==='TEC')?TEC:CUL;
      return lib[level];
    }
    function generateRoadmap(barrierScores, global){
      const eco = getBarrierPlan('ECO', barrierScores.ECO.level);
      const tec = getBarrierPlan('TEC', barrierScores.TEC.level);
      const cul = getBarrierPlan('CUL', barrierScores.CUL.level);
      const uniq = arr => Array.from(new Set(arr));
      const now = uniq([...(eco?.now||[]), ...(tec?.now||[]), ...(cul?.now||[])]);
      const mid = uniq([...(eco?.mid||[]), ...(tec?.mid||[]), ...(cul?.mid||[])]);
      const long= uniq([...(eco?.long||[]),...(tec?.long||[]),...(cul?.long||[])]);
      const title90 = global>=4 ? "Optimizaci√≥n (0‚Äì90 d√≠as)" : global>=2.5 ? "Estandarizaci√≥n (0‚Äì90 d√≠as)" : "Fundamentos (0‚Äì90 d√≠as)";
      const title6m = global>=4 ? "Escalamiento (3‚Äì6 meses)" : global>=2.5 ? "Aceleraci√≥n (3‚Äì6 meses)" : "Consolidaci√≥n (3‚Äì6 meses)";
      const title18m= global>=4 ? "Innovaci√≥n (12‚Äì18 meses)" : global>=2.5 ? "Avance estrat√©gico (12‚Äì18 meses)" : "Expansi√≥n (12‚Äì18 meses)";
      return `
        <div class="tcol"><h4>${title90}</h4><ul>${now.map(x=>`<li>${x}</li>`).join("")}</ul></div>
        <div class="tcol"><h4>${title6m}</h4><ul>${mid.map(x=>`<li>${x}</li>`).join("")}</ul></div>
        <div class="tcol"><h4>${title18m}</h4><ul>${long.map(x=>`<li>${x}</li>`).join("")}</ul></div>
      `;
    }
    function computeBarrierScores(answers){
      const out = {};
      for(const code of Object.keys(BARRIERS)){
        const ids = BARRIERS[code].items;
        const scores = ids.map(id=>{
          const item = ITEMS.find(it=>it.id===id);
          if(!item) return 0;
          return scoreItem(item, answers[id]);
        }).filter(v=>v>0);
        const avg = scores.reduce((a,b)=>a+b,0) / (scores.length || 1);
        out[code] = { avg, level: LEVEL(avg) };
      }
      return out;
    }
  </script>
</section>

<!-- Bootstrap bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- html2pdf (PDF directo sin imprimir) -->
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<script>
/* ================== CONFIG BACKEND ================== */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzMfoPNKqStQ8HGJ-xde3xxx-NJqr8XQKw6ZgrvqTWPmNeCuJR5VddChadbDb5Gjyox/exec"; // ‚Üê reemplaza por tu URL
/* Estado (global para usar en PDF) */
window.currentEmail = null;
window.currentCompany = null;

/* ===== Helpers ===== */
const qs  = (s, p=document)=> p.querySelector(s);
const qsa = (s, p=document)=> [...p.querySelectorAll(s)];
const navAnon = qs('#navAnon');
const navAuth = qs('#navAuth');
const navCompany = qs('#navCompany');
const brandName = qs('#brandName');
const landing = qs('#landing');
const welcomeSection = qs('#welcomeSection');
const prevResultsSection = qs('#prevResultsSection');
const resultsList = qs('#resultsList');
const autoDx = qs('#autoDx');

function showOnly(sectionEl){
  [landing, welcomeSection, prevResultsSection, autoDx].forEach(el => el.style.display='none');
  if(sectionEl) sectionEl.style.display = 'block';
  window.scrollTo({top:0, behavior:'smooth'});
}
function setLoggedUI(on){
  if(on){
    navAnon.classList.add('d-none');
    navAuth.classList.remove('d-none');
    navCompany.textContent = window.currentCompany || 'Empresa';
    brandName.textContent = 'Chequeo Digital';
  }else{
    navAnon.classList.remove('d-none');
    navAuth.classList.add('d-none');
    brandName.textContent = 'Chequeo Digital';
    navCompany.textContent = 'Empresa';
  }
}

/* ===== Modales ===== */
const registroModal = qs('#registroModal');
const loginModal = qs('#loginModal');
const mensaje = qs('#mensaje');
const loginMessage = qs('#loginMessage');

/* Abrir SOLO el modal correcto */
qsa('.openRegistro').forEach(b => b.addEventListener('click', e => {
  e.preventDefault(); registroModal.style.display = 'flex';
}));
qsa('.openLogin').forEach(b => b.addEventListener('click', e => {
  e.preventDefault(); loginModal.style.display = 'flex';
}));
qsa('.closeModal').forEach(b=>b.addEventListener('click', closeAllModals));

function closeAllModals(){
  registroModal.style.display='none';
  loginModal.style.display='none';
  mensaje.textContent=''; loginMessage.textContent='';
  const f1 = qs('#registroForm'); if (f1) f1.reset();
  const f2 = qs('#loginForm');    if (f2) f2.reset();
}

/* ===== Soporte (icono de ayuda) ===== */
const navHelpBtn = qs('#navHelp');
if(navHelpBtn){
  navHelpBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    alert('Por favor colocarse en contacto con auxsoportechequeodigital@gmail.com');
  });
}

/* ===== Registro ===== */
qs('#registroForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  mensaje.textContent='';
  const nombre = qs('#empresaReg').value.trim();
  const email  = qs('#email').value.trim();
  const pass   = qs('#password').value;
  const btn    = qs('#btnRegistrar');

  btn.disabled = true; btn.textContent = 'Registrando...';
  const fd = new FormData();
  fd.append('action','register'); fd.append('nombre',nombre); fd.append('email',email); fd.append('password',pass);

  try{
    const res = await fetch(WEBAPP_URL, {method:'POST', body:fd});
    const txt = await res.text();
    if(txt==='OK'){
      mensaje.style.color='green'; mensaje.textContent='‚úÖ Registro exitoso';
      window.currentEmail = email; window.currentCompany = nombre;
      const f1 = qs('#registroForm'); if (f1) f1.reset();
      closeAllModals(); setLoggedUI(true);
      qs('#welcCompany').textContent = window.currentCompany;
      const edx = document.getElementById('empresaDx'); if(edx){ edx.value = window.currentCompany; }
      showOnly(welcomeSection);
    }else if(txt==='EXISTE'){
      mensaje.style.color='orange'; mensaje.textContent='‚ö†Ô∏è Ya existe ese correo o empresa';
      btn.disabled=false; btn.textContent='Registrarse';
    }else{
      mensaje.style.color='red'; mensaje.textContent='‚ùå Error: '+txt;
      btn.disabled=false; btn.textContent='Registrarse';
    }
  }catch(err){
    mensaje.style.color='red'; mensaje.textContent='‚ùå Error de red';
    btn.disabled=false; btn.textContent='Registrarse';
  }
});

/* ===== Login ===== */
qs('#loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  loginMessage.textContent='';
  const email = qs('#loginEmail').value.trim();
  const pass  = qs('#loginPassword').value;
  const btn   = qs('#btnLogin');

  btn.disabled = true; btn.textContent = 'Verificando...';
  const fd = new FormData();
  fd.append('action','login'); fd.append('email',email); fd.append('password',pass);

  try{
    const res = await fetch(WEBAPP_URL, {method:'POST', body:fd});
    const raw = await res.text();
    let status = raw, nombre = null;
    try{ const j = JSON.parse(raw); status = j.status || raw; nombre = j.nombre || null; }catch{}

    if(status==='OK'){
      if(!nombre){
        const prof = await fetchJSON({action:'get_profile', email});
        nombre = (prof && prof.nombre) ? prof.nombre : null;
      }
      window.currentEmail   = email;
      window.currentCompany = nombre || 'Empresa';
      const f2 = qs('#loginForm'); if (f2) f2.reset();
      closeAllModals(); setLoggedUI(true);
      navCompany.textContent = window.currentCompany || 'Empresa';
      qs('#resCompany').textContent = window.currentCompany;
      const edx = document.getElementById('empresaDx'); if(edx){ edx.value = window.currentCompany; }
      showOnly(prevResultsSection);
      await loadPreviousResults();
    }else if(status==='ERROR_PASS'){
      loginMessage.style.color='red'; loginMessage.textContent='‚ùå Contrase√±a incorrecta';
      btn.disabled=false; btn.textContent='Iniciar sesi√≥n';
    }else if(status==='NOEXISTE'){
      loginMessage.style.color='red'; loginMessage.textContent='‚ùå Usuario no registrado';
      btn.disabled=false; btn.textContent='Iniciar sesi√≥n';
    }else{
      loginMessage.style.color='red'; loginMessage.textContent='‚ùå Error: '+status;
      btn.disabled=false; btn.textContent='Iniciar sesi√≥n';
    }
  }catch(err){
    loginMessage.style.color='red'; loginMessage.textContent='‚ùå Error de red';
    btn.disabled=false; btn.textContent='Iniciar sesi√≥n';
  }
});

/* ===== Recuperar contrase√±a ===== */
qs('#forgotPass').addEventListener('click', async (e)=>{
  e.preventDefault();
  const email = qs('#loginEmail').value.trim();
  if(!email) return alert('Ingresa tu correo');
  const txt = await fetchText({action:'recover', email});
  alert(txt);
});

/* ===== Logout ===== */
qs('#btnLogout').addEventListener('click', ()=>{
  // Limpia formularios y estados
  closeAllModals();
  try{ qs('#dxForm').reset(); }catch{}
  qsa('#dxForm input[type="checkbox"], #dxForm input[type="radio"]').forEach(el => el.checked = false);
  const edx = qs('#empresaDx'); if(edx) edx.value = '';
  qsa('#empresaReg, #email, #password, #loginEmail, #loginPassword').forEach(el => { if(el) el.value=''; });
  window.currentEmail = null; window.currentCompany = null;
  setLoggedUI(false);
  showOnly(landing);
  // Reinicia navegaci√≥n del cuestionario
  try{
    if(typeof showStep==='function'){ idx = 0; showStep(0); }
  }catch{}
  // Recarga la p√°gina
  setTimeout(()=> window.location.reload(), 0);
});

/* ===== Ir al Autodiagn√≥stico ===== */
qs('#goToDx1').addEventListener('click', ()=>{
  startNewDx();
  showOnly(autoDx);
});
qs('#goToDx2').addEventListener('click', ()=>{
  startNewDx();
  showOnly(autoDx);
});

/* ===== Utilidades fetch ===== */
async function fetchText(obj){
  const fd = new FormData(); Object.keys(obj).forEach(k=> fd.append(k, obj[k]));
  const r = await fetch(WEBAPP_URL, {method:'POST', body:fd});
  return await r.text();
}
async function fetchJSON(obj){ const t = await fetchText(obj); try{ return JSON.parse(t); }catch{ return null; } }

/* ===== Parser fecha/hora dd/mm/aaaa HH:mm(:ss) con a. m./p. m. ===== */
function parseCoDateTime(s){
  if(!s) return new Date(0);
  // 1) Intenta nativo
  const dn = new Date(s);
  if(!isNaN(dn)) return dn;

  // 2) Parser manual dd/mm/aaaa[, ]hh:mm(:ss)? (a. m.|p. m.)?
  s = String(s).replace(/\u00A0/g,' ').trim(); // NBSP ‚Üí espacio normal
  const m = s.match(
    /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:[,\s]+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(a\.?\s*m\.?|p\.?\s*m\.?)?)?/i
  );
  if(m){
    const dd = +m[1];
    const mm = (+m[2]) - 1;
    let yyyy = +m[3]; if(yyyy < 100) yyyy = 2000 + yyyy;
    let hh = +(m[4] || 0);
    const mi = +(m[5] || 0);
    const ss = +(m[6] || 0);
    const ampm = (m[7] || '').toLowerCase();

    if(ampm){
      if(ampm.startsWith('p') && hh < 12) hh += 12; // 1‚Äì11 pm ‚Üí +12
      if(ampm.startsWith('a') && hh === 12) hh = 0; // 12 am ‚Üí 0
    }
    return new Date(yyyy, mm, dd, hh, mi, ss);
  }
  return new Date(0);
}

/* ===== Resultados previos + comparativo ===== */
async function loadPreviousResults(){
  navCompany.textContent = window.currentCompany || 'Empresa';

  resultsList.innerHTML = `<div class="col-12 text-center py-4">Cargando resultados...</div>`;
  const data = await fetchJSON({action:'list_results', email: window.currentEmail});
  const summaryEl = qs('#resultsSummary');
  summaryEl.innerHTML = '';

  if(!data || !Array.isArray(data) || data.length===0){
    resultsList.innerHTML = `<div class="col-12"><div class="card-soft p-4 text-center">A√∫n no tienes autodiagn√≥sticos guardados. ¬°Realiza el primero!<br><button class="btn btn-primary rounded-pill mt-3" id="goToDx3">Nuevo Autodiagn√≥stico</button></div></div>`;
    const b = qs('#goToDx3'); if(b) b.addEventListener('click', ()=> { startNewDx(); showOnly(autoDx); });
    return;
  }

  // Ordenar por fecha descendente (m√°s reciente primero)
  data.sort((a,b)=> parseCoDateTime(b.fecha) - parseCoDateTime(a.fecha));

// Comparativo: pen√∫ltimo (anterior) vs m√°s reciente
if (data.length >= 2){
  const reciente = data[0];      // m√°s reciente
  const anterior = data[1];      // inmediatamente anterior

  const gRec = Number(reciente.global) || 0;
  const gAnt = Number(anterior.global) || 0;

  // Cambio desde el ANTERIOR ‚Üí al RECIENTE (orientaci√≥n temporal correcta)
  const cambio = gRec - gAnt;
  const palabra = cambio > 0 ? 'aument√≥' : (cambio < 0 ? 'disminuy√≥' : 'se mantuvo igual');
  const cambioAbsTxt = Math.abs(cambio).toFixed(2);

  // Variaciones por dimensi√≥n (anterior ‚Üí reciente)
  let dimMsg = '';
  try{
    const dRec = JSON.parse(reciente.dimAvg || '{}') || {};
    const dAnt = JSON.parse(anterior.dimAvg || '{}') || {};
    const dims = ['D1','D2','D3','D4','D5','D6'];
    const nombres = {
      D1:'Tecnolog√≠a y habilidades', D2:'Comunicaciones y canales',
      D3:'Organizaci√≥n y personas',  D4:'Estrategia y TD',
      D5:'Datos y anal√≠tica',        D6:'Procesos'
    };
    const cambios = dims
      .map(k => ({ k, dv: (Number(dRec[k])||0) - (Number(dAnt[k])||0) }))
      .sort((a,b) => Math.abs(b.dv) - Math.abs(a.dv))
      .slice(0,2);

    dimMsg = cambios.length
      ? `Mayor variaci√≥n en: <strong>${nombres[cambios[0].k]}</strong> (${cambios[0].dv.toFixed(2)})${cambios[1] ? ` y <strong>${nombres[cambios[1].k]}</strong> (${cambios[1].dv.toFixed(2)})` : ''}.`
      : '';
  }catch{}

  summaryEl.innerHTML = `
    <div class="alert alert-info rounded-4">
      <div class="fw-semibold mb-1">Comparativo reciente</div>
      <div>El nivel global <strong>${palabra}</strong> ${cambioAbsTxt} puntos (del ${gAnt.toFixed(2)} al ${gRec.toFixed(2)}).</div>
      <div class="mt-1 small">${dimMsg}</div>
    </div>`;
}


  resultsList.innerHTML = data.map(row=>{
    const nivel = row.nivel || '‚Äî';
    const fecha = row.fecha || '';
    const glb = parseFloat(row.global || 0).toFixed(2);
    return `
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card-soft p-3 h-100 d-flex flex-column">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="small text-muted">${fecha}</div>
              <h5 class="mb-1">Global: ${glb}</h5>
              <span class="badge ${nivelBadgeClass(nivel)}">${nivel}</span>
            </div>
            <i class="bi bi-clipboard-data text-primary fs-4"></i>
          </div>
          <div class="mt-3 d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm rounded-pill viewResult" data-id="${row.id}"><i class="bi bi-eye me-1"></i>Ver reporte</button>
            <button class="btn btn-primary btn-sm rounded-pill printResult" data-id="${row.id}"><i class="bi bi-download me-1"></i>Descargar PDF</button>
          </div>
        </div>
      </div>`;
  }).join('');

  qsa('.viewResult').forEach(b=> b.addEventListener('click', async ()=>{
    const id = b.dataset.id;
    const found = (data||[]).find(x=> x.id==id);
    if(found){ openSavedReport(found); }
  }));
  qsa('.printResult').forEach(b=> b.addEventListener('click', async ()=>{
    const id = b.dataset.id;
    const found = (data||[]).find(x=> x.id==id);
    if(found){
      openSavedReport(found, false);
      setTimeout(()=> downloadPDF(), 400);
    }
  }));
}
function nivelBadgeClass(n){ if(n==='Bajo') return 'text-bg-danger'; if(n==='Intermedio') return 'text-bg-warning'; return 'text-bg-success'; }

/* ===== Ver reporte guardado en el componente ===== */
function openSavedReport(row, autoPrint=false){
  try{
    const dimAvg = JSON.parse(row.dimAvg || '{}');
    const barriers = JSON.parse(row.barriers || '{}');
    const levelDim = {}; Object.keys(dimAvg).forEach(k=> levelDim[k] = (dimAvg[k] >= 4.0) ? 'Avanzado' : (dimAvg[k] >= 2.5 ? 'Intermedio' : 'Bajo'));
    const payload = {dimAvg, levelDim, global: parseFloat(row.global), levelGlobal: row.nivel};
    showOnly(autoDx);
    if(typeof window.renderResults==='function') window.renderResults(payload);
    const repEmpresa = document.getElementById('repEmpresa'); if(repEmpresa) repEmpresa.textContent = window.currentCompany || row.nombre || 'Empresa';
    const repFecha = document.getElementById('repFecha'); if(repFecha) repFecha.textContent = row.fecha || new Date().toLocaleDateString('es-CO');
    if(typeof window.buildReport==='function') window.buildReport(payload, barriers);
    lockDx(); // ‚¨ÖÔ∏è bloquea navegaci√≥n al ver un informe guardado
    if(autoPrint){ setTimeout(()=>downloadPDF(), 400); }
  }catch(e){ console.error(e); alert('No fue posible abrir el informe guardado.'); }
}

/* ===== Guardar resultado desde el Autodiagn√≥stico ===== */
window.saveDxResult = async function(payload, barriers, answers){
  const fd = new FormData();
  fd.append('action','save_result');
  fd.append('email',  window.currentEmail || '');
  fd.append('nombre', window.currentCompany || (document.getElementById('empresaDx')?.value || 'Empresa no especificada'));
  fd.append('fecha',  new Date().toLocaleString('es-CO'));
  fd.append('global', payload.global.toFixed(2));
  fd.append('nivel',  payload.levelGlobal);
  fd.append('dimAvg', JSON.stringify(payload.dimAvg || {}));
  fd.append('barriers', JSON.stringify(barriers || {}));
  fd.append('answers', JSON.stringify(answers || {}));
  try{ const res = await fetch(WEBAPP_URL, {method:'POST', body: fd}); const txt = await res.text(); console.log('save_result:', txt); }
  catch(e){ console.warn('No se pudo guardar en Sheets:', e); }
};
</script>

<!-- ====== Librer√≠as PDF ====== -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script>
/* ==== Utilidades para PDF ==== */
async function svgToPngDataURL(svgEl, scale = 2) {
  if (!svgEl) return null;
  const rect = svgEl.getBoundingClientRect();
  const w = Math.max(1, rect.width), h = Math.max(1, rect.height);
  const xml = new XMLSerializer().serializeToString(svgEl);
  const svg64 = btoa(unescape(encodeURIComponent(xml)));
  const imgSrc = 'data:image/svg+xml;base64,' + svg64;
  return await new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = w * scale; canvas.height = h * scale;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      resolve(canvas.toDataURL('image/png'));
    };
    img.src = imgSrc;
  });
}
function pdfSectionTitle(doc, text, x, y) {
  doc.setFont('helvetica', 'bold'); doc.setFontSize(14);
  doc.setTextColor(31,42,68); doc.text(text, x, y);
  return y + 6;
}
function drawChip(doc, x, y, text, fillRGB, textRGB=[255,255,255]) {
  const w = doc.getTextWidth(text) + 6; const h = 6;
  doc.setFillColor(...fillRGB); doc.roundedRect(x, y-4, w, h, 2, 2, 'F');
  doc.setTextColor(...textRGB); doc.setFont('helvetica','bold'); doc.setFontSize(10);
  doc.text(text, x+3, y);
  return x + w + 4;
}
function drawLevelPanel(doc, x, y, w, h, gLvl, score, gaugeDataURL){
  doc.setFillColor(255,255,255); doc.roundedRect(x, y, w, h, 3, 3, 'F');
  doc.setDrawColor(230,235,248); doc.roundedRect(x, y, w, h, 3, 3, 'S');
  if (gaugeDataURL) doc.addImage(gaugeDataURL, 'PNG', x+3, y+3, 24, 24, undefined, 'FAST');
  doc.setTextColor(31,42,68); doc.setFont('helvetica','bold'); doc.setFontSize(14);
  doc.text((score||0).toFixed(2), x+31, y+13);
  const color = gLvl==='Bajo' ? [231,76,60] : (gLvl==='Intermedio' ? [243,156,18] : [46,204,113]);
  drawChip(doc, x+28, y+24, gLvl, color);
}

/* ==== Generar PDF multip√°gina con encabezado pro (descarga autom√°tica) ==== */
async function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'mm', format: 'a4', compress: true });

  const empresa = (document.getElementById('repEmpresa')?.textContent || 'Empresa no especificada').trim();
  const fecha = (document.getElementById('repFecha')?.textContent || new Date().toLocaleDateString('es-CO'));

  // Recalcular desde el estado actual del reporte
  const answers = collectAnswers();
  const res = computeScores(answers);
  const dimAvg = res.dimAvg, levelDim = res.levelDim;
  const global = res.global, gLvl = res.levelGlobal;
  const barriers = computeBarrierScores(answers);

  /* ===== PORTADA ===== */
  doc.setFillColor(37,51,89); doc.rect(0, 0, 210, 42, 'F');
  doc.setTextColor(255,255,255);
  doc.setFont('helvetica','bold'); doc.setFontSize(18); doc.text('Informe de Autodiagn√≥stico', 14, 16);
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  doc.text(`Empresa: ${empresa} - Fecha: ${fecha}`, 14, 24);

  let cx = 14, cy = 33;
  cx = drawChip(doc, cx, cy, 'Bajo < 2.5', [196,61,47]);
  cx = drawChip(doc, cx, cy, 'Intermedio 2.5-3.9', [209,142,30]);
  drawChip(doc, cx, cy, 'Avanzado >= 4.0', [30,171,95]);

  let gaugeUrl = null; 
  try { const gaugeSvg = document.querySelector('#gaugeGlobal svg'); if (gaugeSvg) gaugeUrl = await svgToPngDataURL(gaugeSvg, 2); } catch(e){}
  drawLevelPanel(doc, 150, 6, 52, 30, gLvl, global, gaugeUrl);

  let y = 50;

  /* ===== Resumen ejecutivo ===== */
  y = pdfSectionTitle(doc, 'Resumen ejecutivo', 14, y);
  doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.setTextColor(31,42,68);
  const names = {D1:'Tecnolog√≠a y habilidades', D2:'Comunicaciones y canales', D3:'Organizaci√≥n y personas', D4:'Estrategia y TD', D5:'Datos y anal√≠tica', D6:'Procesos'};
  const pairs = Object.entries(dimAvg).map(([k,v])=>({k,v})).sort((a,b)=>b.v-a.v);
  const strengths = pairs.filter(p=>p.v>=3.8).slice(0,2).map(s=>`${names[s.k]} (${s.v.toFixed(2)})`).join(' y ') || 'sin fortalezas destacadas >= 3.8';
  const gaps = pairs.filter(p=>p.v<2.5).slice(0,2).map(s=>`${names[s.k]} (${s.v.toFixed(2)})`).join(' y ') || 'sin brechas cr√≠ticas < 2.5';
  const tone = gLvl==='Avanzado' ? 
    'posici√≥n l√≠der en madurez digital con capacidades consolidadas y potencial para escalar innovaci√≥n.' :
    (gLvl==='Intermedio' ? 
      'nivel en consolidaci√≥n; hay bases s√≥lidas y oportunidades claras de estandarizaci√≥n y escalamiento.' :
      'etapa inicial; urge establecer fundamentos tecnol√≥gicos, de datos y de cultura para capturar valor.');
  const lines = doc.splitTextToSize(
    `La organizaci√≥n presenta un nivel ${gLvl} (${global.toFixed(2)} / 5), en ${tone}
Fortalezas: ${strengths}.
Brechas prioritarias: ${gaps}.`, 182);
  doc.text(lines, 14, y); y += (lines.length * 5) + 6;

  /* ===== Barreras (promedio) ===== */
  y = pdfSectionTitle(doc, 'Barreras (promedio)', 14, y);
  doc.setFontSize(11);
  doc.text(`Econ√≥micas: ${barriers.ECO.avg.toFixed(2)} - ${barriers.ECO.level}`, 14, y); y+=6;
  doc.text(`Tecnol√≥gicas: ${barriers.TEC.avg.toFixed(2)} - ${barriers.TEC.level}`, 14, y); y+=6;
  doc.text(`Culturales: ${barriers.CUL.avg.toFixed(2)} - ${barriers.CUL.level}`, 14, y); y+=8;

  /* ===== Gr√°fica por Dimensi√≥n ===== */
  y = pdfSectionTitle(doc, 'Desempe√±o por Dimensi√≥n', 14, y);
  y = await (async ()=>{
    const svg = document.querySelector('#chart svg');
    if (!svg) return y;
    const r = svg.getBoundingClientRect();
    const wmm = 182, hmm = (r.height/(r.width||1))*wmm;
    if (y + hmm > 287) { doc.addPage(); y = 20; }
    const img = await svgToPngDataURL(svg, 2);
    if (img) doc.addImage(img, 'PNG', 14, y, wmm, hmm, undefined, 'FAST');
    return y + hmm + 8;
  })();

  /* ===== Gr√°fica por Barrera ===== */
  y = pdfSectionTitle(doc, 'Desempe√±o por Barrera', 14, y);
  y = await (async ()=>{
    const svg = document.querySelector('#barrierChart svg');
    if (!svg) return y;
    const r = svg.getBoundingClientRect();
    const wmm = 182, hmm = (r.height/(r.width||1))*wmm;
    if (y + hmm > 287) { doc.addPage(); y = 20; }
    const img = await svgToPngDataURL(svg, 2);
    if (img) doc.addImage(img, 'PNG', 14, y, wmm, hmm, undefined, 'FAST');
    return y + hmm + 8;
  })();

  /* ===== Tabla por Dimensi√≥n ===== */
  if (y > 260) { doc.addPage(); y = 20; }
  y = pdfSectionTitle(doc, 'Tabla por Dimensi√≥n', 14, y);
  const dimRows = [
    ['Tecnolog√≠a y habilidades', (dimAvg.D1||0).toFixed(2), LEVEL(dimAvg.D1||0)],
    ['Comunicaciones y canales', (dimAvg.D2||0).toFixed(2), LEVEL(dimAvg.D2||0)],
    ['Organizaci√≥n y personas', (dimAvg.D3||0).toFixed(2), LEVEL(dimAvg.D3||0)],
    ['Estrategia y TD', (dimAvg.D4||0).toFixed(2), LEVEL(dimAvg.D4||0)],
    ['Datos y anal√≠tica', (dimAvg.D5||0).toFixed(2), LEVEL(dimAvg.D5||0)],
    ['Procesos', (dimAvg.D6||0).toFixed(2), LEVEL(dimAvg.D6||0)],
  ];
  doc.autoTable({
    startY: y, head: [['Dimensi√≥n','Promedio','Nivel']], body: dimRows,
    theme: 'grid', styles: { fontSize: 10, cellPadding: 2 },
    headStyles: { fillColor: [238,242,255], textColor:[42,55,99] },
    columnStyles: { 0:{cellWidth:90}, 1:{cellWidth:25, halign:'right'}, 2:{cellWidth:60} }
  });
  y = doc.lastAutoTable.finalY + 8;

  /* ===== An√°lisis por dimensi√≥n ===== */
  if (y > 260) { doc.addPage(); y = 20; }
  y = pdfSectionTitle(doc, 'An√°lisis por dimensi√≥n', 14, y);
  const focusText = (lvl)=> lvl==='Bajo' ? 'Prioriza m√≠nimos viables y casos de valor de corto plazo.' :
                      (lvl==='Intermedio' ? 'Consolida est√°ndares, mide impacto y acelera automatizaci√≥n/anal√≠tica.' :
                      'Optimiza y escala; explora tecnolog√≠as emergentes con ROI controlado.');
  const analRows = Object.keys(names).map(k => [names[k], `${(dimAvg[k]||0).toFixed(2)} - ${LEVEL(dimAvg[k]||0)}`, focusText(LEVEL(dimAvg[k]||0))]);
  doc.autoTable({
    startY: y,
    head: [['Dimensi√≥n','Puntaje','Enfoque recomendado']],
    body: analRows,
    theme: 'grid',
    styles: { fontSize: 10, cellPadding: 2 },
    headStyles: { fillColor: [238,242,255], textColor:[42,55,99] },
    columnStyles: { 0:{cellWidth:55}, 1:{cellWidth:35}, 2:{cellWidth:100} }
  });
  y = doc.lastAutoTable.finalY + 8;

  /* ===== An√°lisis por barrera ===== */
  if (y > 260) { doc.addPage(); y = 20; }
  y = pdfSectionTitle(doc, 'An√°lisis por barrera', 14, y);
  const planEco = getBarrierPlan('ECO', barriers.ECO.level);
  const planTec = getBarrierPlan('TEC', barriers.TEC.level);
  const planCul = getBarrierPlan('CUL', barriers.CUL.level);
  const list = (arr)=> (arr||[]).map(x=>'‚Ä¢ '+x.replace(/<[^>]+>/g,'')).join('\n');
  doc.autoTable({
    startY: y,
    head: [['Barrera','Puntaje','Nivel','Acciones clave (0-90 d√≠as)']],
    body: [
      ['Econ√≥micas', barriers.ECO.avg.toFixed(2), barriers.ECO.level, list(planEco?.now)],
      ['Tecnol√≥gicas', barriers.TEC.avg.toFixed(2), barriers.TEC.level, list(planTec?.now)],
      ['Culturales', barriers.CUL.avg.toFixed(2), barriers.CUL.level, list(planCul?.now)]
    ],
    theme: 'grid',
    styles: { fontSize: 10, cellPadding: 2, valign:'top' },
    headStyles: { fillColor: [238,242,255], textColor:[42,55,99] },
    columnStyles: { 0:{cellWidth:35}, 1:{cellWidth:20, halign:'right'}, 2:{cellWidth:28}, 3:{cellWidth:115} }
  });
  y = doc.lastAutoTable.finalY + 8;

  /* ===== Hoja de ruta ===== */
  const uniq = (a)=>Array.from(new Set(a||[]));
  const now = uniq([...(planEco?.now||[]), ...(planTec?.now||[]), ...(planCul?.now||[]) ]).map(x=>'‚Ä¢ '+x.replace(/<[^>]+>/g,'')).join('\n');
  const mid = uniq([...(planEco?.mid||[]), ...(planTec?.mid||[]), ...(planCul?.mid||[]) ]).map(x=>'‚Ä¢ '+x.replace(/<[^>]+>/g,'')).join('\n');
  const long= uniq([...(planEco?.long||[]),...(planTec?.long||[]),...(planCul?.long||[]) ]).map(x=>'‚Ä¢ '+x.replace(/<[^>]+>/g,'')).join('\n');

  if (y > 260) { doc.addPage(); y = 20; }
  const title90 = global>=4 ? 'Optimizaci√≥n (0-90 d√≠as)' : global>=2.5 ? 'Estandarizaci√≥n (0-90 d√≠as)' : 'Fundamentos (0-90 d√≠as)';
  const title6m = global>=4 ? 'Escalamiento (3-6 meses)' : global>=2.5 ? 'Aceleraci√≥n (3-6 meses)' : 'Consolidaci√≥n (3-6 meses)';
  const title18 = global>=4 ? 'Innovaci√≥n (12-18 meses)' : global>=2.5 ? 'Avance estrat√©gico (12-18 meses)' : 'Expansi√≥n (12-18 meses)';
  y = pdfSectionTitle(doc, 'Hoja de ruta recomendada', 14, y);
  doc.autoTable({
    startY: y,
    head: [[title90, title6m, title18]],
    body: [[ now, mid, long ]],
    styles: { fontSize: 10, cellPadding: 2, valign: 'top', minCellHeight: 6 },
    headStyles: { fillColor: [238,242,255], textColor:[42,55,99] },
    columnStyles: { 0:{cellWidth:63}, 1:{cellWidth:63}, 2:{cellWidth:63} }
  });

  const safeName = empresa.replace(/[^\w\s.-]+/g,'_').slice(0,50) || 'Autodiagnostico';
  doc.save(`Informe_Autodiagnostico_${safeName}.pdf`);
}

/* Compatibilidad con botones existentes que llaman downloadPDF() */
function downloadPDF(){ return generatePDF(); }
</script>

</body>
</html>
